# VantageData 授权服务器使用文档

## 目录

1. [系统概述](#系统概述)
2. [快速开始](#快速开始)
3. [管理界面使用](#管理界面使用)
4. [客户端激活](#客户端激活)
5. [API 接口说明](#api-接口说明)
6. [常见问题](#常见问题)

---

## 系统概述

VantageData 授权服务器是一个完整的软件授权管理系统，提供以下核心功能：

- **序列号管理**：生成、管理和分发产品序列号
- **API 配置分发**：集中管理和分发 LLM API 和搜索引擎 API 配置
- **分组管理**：支持将 API 配置按分组管理，不同序列号可绑定不同分组
- **邮箱申请系统**：用户可通过邮箱自助申请序列号
- **使用限制**：支持设置每日分析次数限制和有效期管理
- **加密传输**：所有配置信息使用 AES-256-GCM 加密传输

### 架构特点

- **双端口服务**：
  - 管理端口（默认 8899）：Web 管理界面
  - 授权端口（默认 6699）：客户端激活 API
- **加密存储**：使用 SQLite + go-sqlcipher 加密数据库
- **安全传输**：支持 HTTPS/SSL 配置

---

## 快速开始

### 1. 编译服务器

```bash
cd tools/license_server
go build -o license_server .
```

### 2. 启动服务器

```bash
./license_server
```

启动成功后会显示：
```
Management server starting on :8899 (HTTP)
Auth server starting on :6699 (HTTP)
```

### 3. 访问管理界面

打开浏览器访问：`http://localhost:8899`

**默认登录信息：**
- 用户名：`admin`
- 密码：`sunion123`

> ⚠️ **安全提示**：首次登录后请立即修改默认密码！

---

## 管理界面使用

### 3.1 序列号管理

#### 生成单个序列号

1. 进入"序列号管理"标签页
2. 点击"生成序列号"按钮
3. 填写以下信息：
   - **描述**：序列号用途说明（可选）
   - **有效天数**：序列号有效期（默认 365 天）
   - **每日分析次数**：限制每日分析次数（0 表示无限制，默认 20）
   - **LLM 分组**：绑定的 LLM API 分组（可选）
   - **搜索分组**：绑定的搜索引擎分组（可选）
4. 点击"确定"生成

**序列号格式**：`XXXX-XXXX-XXXX-XXXX`（16 位大写字母和数字）

#### 批量生成序列号

1. 点击"批量生成"按钮
2. 设置生成数量（最多 1000 个）
3. 配置统一的有效期、分析次数和分组
4. 生成后可导出序列号列表

#### 序列号操作

- **搜索**：支持按序列号或描述搜索
- **展期**：延长序列号有效期
- **禁用/启用**：临时禁用或重新启用序列号
- **修改每日分析次数**：调整使用限制
- **修改分组绑定**：更改 API 配置分组
- **删除**：永久删除序列号

### 3.2 LLM 配置管理

#### 创建 LLM 分组

1. 进入"LLM 配置"标签页
2. 点击"管理分组"
3. 点击"新建分组"
4. 填写分组名称和描述
5. 保存

**分组用途**：将不同的 API Key 按用途或客户分组，序列号绑定分组后只会获取该分组的配置。

#### 添加 LLM 配置

1. 点击"添加配置"按钮
2. 填写配置信息：
   - **名称**：配置名称（如"OpenAI 主账号"）
   - **类型**：选择 LLM 类型（OpenAI、Anthropic、Gemini、DeepSeek）
   - **Base URL**：API 基础地址
   - **API Key**：API 密钥
   - **模型**：使用的模型名称（如 gpt-4o）
   - **生效日期**：配置开始生效的日期
   - **截止日期**：配置失效的日期（可选）
   - **分组**：选择所属分组
   - **设为当前使用**：标记为优先使用的配置
3. 保存配置

#### 配置优先级规则

当序列号激活时，系统会按以下规则选择最佳配置：
1. 只选择在有效期内的配置（当前日期在生效日期和截止日期之间）
2. 优先选择生效日期最新的配置
3. 同日期时优先选择标记为"当前使用"的配置

### 3.3 搜索引擎配置管理

#### 创建搜索分组

操作方式与 LLM 分组相同。

#### 添加搜索引擎配置

1. 点击"添加配置"按钮
2. 填写配置信息：
   - **名称**：配置名称
   - **类型**：选择搜索引擎（Tavily、Serper、Bing）
   - **API Key**：搜索引擎 API 密钥
   - **生效日期**：配置开始生效的日期
   - **截止日期**：配置失效的日期（可选）
   - **分组**：选择所属分组
   - **设为当前使用**：标记为优先使用的配置
3. 保存配置

### 3.4 邮箱申请管理

#### 查看申请记录

1. 进入"邮箱申请记录"标签页
2. 查看所有用户申请记录，包括：
   - 邮箱地址
   - 分配的序列号
   - 申请 IP
   - 申请时间
3. 支持搜索和分页浏览

#### 修改申请记录的序列号

1. 在申请记录中找到需要修改的记录
2. 点击"编辑"按钮
3. 可修改：
   - 有效期
   - LLM 分组绑定
   - 搜索分组绑定
   - 启用/禁用状态

#### 配置邮箱过滤

1. 进入"邮箱过滤"标签页
2. 配置过滤模式：
   - **黑名单模式**：禁止黑名单中的邮箱申请
   - **白名单模式**：只允许白名单中的邮箱申请
   - **混合模式**：同时启用，白名单优先
3. 设置申请限制：
   - **每日 IP 申请次数**：同一 IP 每天最多申请次数（默认 5）
   - **每日 IP 邮箱数**：同一 IP 每天可使用的不同邮箱数（默认 5）

#### 管理白名单

1. 点击"白名单管理"
2. 添加允许的邮箱或域名：
   - 完整邮箱：`user@example.com`
   - 域名匹配：`@company.com`（匹配所有该域名邮箱）
3. 可为白名单条目指定默认的 LLM 和搜索分组
4. 白名单中的邮箱申请时会自动绑定指定的分组

#### 管理黑名单

操作方式与白名单相同，但黑名单不支持分组绑定。

### 3.5 系统设置

#### 修改管理员信息

1. 进入"系统设置"标签页
2. 可修改：
   - 管理员用户名
   - 管理员密码

#### 修改端口配置

1. 设置管理端口和授权端口
2. 保存后需要重启服务器生效

#### 配置 SSL/HTTPS

1. 启用 HTTPS
2. 指定证书文件路径（.crt 或 .pem）
3. 指定密钥文件路径（.key）
4. 保存后重启服务器生效

> ⚠️ **注意**：证书文件必须存在且可读，否则配置会失败。

---

## 客户端激活

### 4.1 使用序列号激活

#### 在 VantageData 客户端中激活

1. 打开 VantageData 应用
2. 进入"设置"或"偏好设置"
3. 找到"产品激活"选项
4. 填写激活信息：
   - **授权服务器地址**：`http://服务器IP:6699`
   - **序列号**：输入获取的序列号
5. 点击"激活"按钮

#### 激活成功后

- LLM 配置会自动应用，设置界面中的 LLM 配置项将被隐藏
- 搜索引擎配置会自动应用，只显示切换按钮
- 配置信息仅保存在内存中，程序退出后清除
- 每日分析次数限制会生效

### 4.2 邮箱申请序列号

#### 申请流程

1. 在 VantageData 客户端点击"申请序列号"
2. 自动跳转到授权服务器申请页面
3. 输入邮箱地址
4. 系统验证后自动生成 30 天有效期的序列号
5. 序列号会显示在页面上，请妥善保存

#### 申请限制

- 同一邮箱只能申请一次
- 同一 IP 每天最多申请 5 次（可由管理员调整）
- 同一 IP 每天最多使用 5 个不同邮箱申请（可由管理员调整）
- 邮箱需通过白名单/黑名单验证

### 4.3 激活数据说明

激活成功后，客户端会收到加密的配置数据，包含：

```json
{
  "llm_type": "openai",
  "llm_base_url": "https://api.openai.com/v1",
  "llm_api_key": "sk-xxx",
  "llm_model": "gpt-4o",
  "llm_start_date": "2026-01-01",
  "llm_end_date": "2026-12-31",
  "search_type": "tavily",
  "search_api_key": "tvly-xxx",
  "search_start_date": "2026-01-01",
  "search_end_date": "2026-12-31",
  "expires_at": "2027-01-01T00:00:00Z",
  "activated_at": "2026-02-01T12:00:00Z",
  "daily_analysis": 20
}
```

---

## API 接口说明

### 5.1 授权服务 API（端口 6699）

#### 激活序列号

**接口**：`POST /activate`

**请求**：
```json
{
  "sn": "XXXX-XXXX-XXXX-XXXX"
}
```

**响应**：
```json
{
  "success": true,
  "message": "激活成功",
  "encrypted_data": "base64加密数据...",
  "expires_at": "2027-01-01"
}
```

**错误响应**：
```json
{
  "success": false,
  "message": "序列号无效/已过期/已被禁用"
}
```

#### 申请序列号

**接口**：`POST /request-sn`

**请求**：
```json
{
  "email": "user@example.com"
}
```

**响应**：
```json
{
  "success": true,
  "message": "序列号申请成功，有效期30天",
  "sn": "XXXX-XXXX-XXXX-XXXX"
}
```

**错误响应**：
```json
{
  "success": false,
  "message": "错误原因",
  "code": "rate_limit"  // 可选的错误代码
}
```

#### 健康检查

**接口**：`GET /health`

**响应**：
```json
{
  "status": "ok"
}
```

### 5.2 管理服务 API（端口 8899）

所有管理 API 需要先登录获取 Cookie 认证。

#### 登录

**接口**：`POST /login`

**请求**：表单数据
- `username`: 用户名
- `password`: 密码
- `captcha_id`: 验证码 ID
- `captcha`: 验证码答案

**响应**：重定向到 `/dashboard` 并设置 session cookie

#### 序列号管理 API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/licenses` | GET | 获取所有序列号 |
| `/api/licenses/search` | GET | 搜索序列号（支持分页） |
| `/api/licenses/create` | POST | 创建单个序列号 |
| `/api/licenses/batch-create` | POST | 批量创建序列号 |
| `/api/licenses/delete` | POST | 删除序列号 |
| `/api/licenses/toggle` | POST | 启用/禁用序列号 |
| `/api/licenses/extend` | POST | 展期序列号 |
| `/api/licenses/set-daily` | POST | 设置每日分析次数 |
| `/api/licenses/set-groups` | POST | 设置分组绑定 |

#### LLM 配置 API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/llm` | GET | 获取所有 LLM 配置 |
| `/api/llm` | POST | 添加/更新 LLM 配置 |
| `/api/llm` | DELETE | 删除 LLM 配置 |
| `/api/llm-groups` | GET | 获取所有 LLM 分组 |
| `/api/llm-groups` | POST | 添加/更新 LLM 分组 |
| `/api/llm-groups` | DELETE | 删除 LLM 分组 |

#### 搜索引擎配置 API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/search` | GET | 获取所有搜索配置 |
| `/api/search` | POST | 添加/更新搜索配置 |
| `/api/search` | DELETE | 删除搜索配置 |
| `/api/search-groups` | GET | 获取所有搜索分组 |
| `/api/search-groups` | POST | 添加/更新搜索分组 |
| `/api/search-groups` | DELETE | 删除搜索分组 |

#### 邮箱管理 API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/email-records` | GET | 获取邮箱申请记录 |
| `/api/email-records/update` | POST | 更新申请记录的序列号配置 |
| `/api/email-filter` | GET | 获取过滤模式配置 |
| `/api/email-filter` | POST | 设置过滤模式 |
| `/api/whitelist` | GET | 获取白名单 |
| `/api/whitelist` | POST | 添加白名单 |
| `/api/whitelist` | DELETE | 删除白名单 |
| `/api/blacklist` | GET | 获取黑名单 |
| `/api/blacklist` | POST | 添加黑名单 |
| `/api/blacklist` | DELETE | 删除黑名单 |

#### 系统设置 API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/password` | POST | 修改管理员密码 |
| `/api/username` | GET/POST | 获取/修改管理员用户名 |
| `/api/ports` | POST | 修改端口配置 |
| `/api/ssl` | GET/POST | 获取/设置 SSL 配置 |

---

## 常见问题

### Q1: 忘记管理员密码怎么办？

**方法 1**：删除数据库文件重新初始化
```bash
rm license_server.db
./license_server
```
> ⚠️ 注意：这会删除所有数据！

**方法 2**：使用数据库工具直接修改
```bash
# 需要使用支持 SQLCipher 的工具，密码为 sunion123!
```

### Q2: 如何备份数据？

直接备份数据库文件：
```bash
cp license_server.db license_server.db.backup
```

### Q3: 序列号激活失败怎么办？

检查以下几点：
1. 序列号是否正确（注意大小写和连字符）
2. 序列号是否已过期
3. 序列号是否被禁用
4. 授权服务器地址是否正确
5. 网络连接是否正常
6. 授权服务器是否正在运行

### Q4: 如何更换 API Key？

1. 在 LLM/搜索配置中添加新的配置
2. 设置新配置的生效日期为当前日期
3. 设置旧配置的截止日期为当前日期
4. 客户端重新激活即可获取新配置

### Q5: 分组功能的使用场景？

**场景 1**：按客户分组
- 为不同客户创建不同的 API 分组
- 每个客户的序列号绑定对应分组
- 便于成本核算和配额管理

**场景 2**：按用途分组
- 测试分组：使用免费或低成本 API
- 生产分组：使用高性能 API
- VIP 分组：使用最优质的 API

**场景 3**：按地区分组
- 国内分组：使用国内可访问的 API
- 国际分组：使用国际 API

### Q6: 每日分析次数如何计算？

- 客户端本地记录当日分析次数
- 每次执行分析前检查是否超限
- 每日零点自动重置计数
- 设置为 0 表示无限制

### Q7: API Key 过期后会怎样？

- 客户端会检查 API Key 的有效期
- 超出有效期的 Key 不会被使用
- 需要重新激活以获取新的有效 Key

### Q8: 如何迁移到新服务器？

1. 停止旧服务器
2. 复制 `license_server.db` 到新服务器
3. 在新服务器上启动服务
4. 客户端无需重新激活（除非更换了服务器地址）

### Q9: 支持多台服务器负载均衡吗？

当前版本不支持。建议使用单台服务器，通过以下方式提高可用性：
- 使用反向代理（Nginx）
- 配置域名而非 IP 地址
- 定期备份数据库

### Q10: 如何监控服务器状态？

使用健康检查接口：
```bash
curl http://localhost:6699/health
```

返回 `{"status":"ok"}` 表示服务正常。

---

## 安全建议

1. **修改默认密码**：首次部署后立即修改管理员密码
2. **启用 HTTPS**：生产环境务必配置 SSL 证书
3. **限制网络访问**：
   - 管理端口（8899）只允许管理员 IP 访问
   - 授权端口（6699）可对外开放
4. **定期备份**：每天自动备份数据库文件
5. **监控日志**：定期检查服务器日志，发现异常及时处理
6. **更新维护**：及时更新服务器程序，修复安全漏洞

---

## 技术支持

如有问题，请联系技术支持团队或查阅完整的系统文档：
- 系统文档：`tools/license_server/licensesys.md`
- README：`tools/license_server/README.md`

---

**文档版本**：1.0  
**最后更新**：2026-02-01
