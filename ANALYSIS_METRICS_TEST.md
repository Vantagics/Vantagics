# 分析请求关键指标功能测试指南

## 测试场景

### 场景1：基本指标提取和显示
**步骤：**
1. 打开应用程序，确保有数据源连接
2. 在聊天区发送分析请求："请分析销售数据的关键指标"
3. 等待LLM回复包含指标信息，例如：
   ```
   根据销售数据分析，以下是关键指标：
   
   销售额: $125,000
   增长率: +15.5%
   订单数量: 1,234
   平均订单价值: $101.30
   转化率: 3.2%
   客户数量: 856
   ```

**预期结果：**
- Dashboard的"核心指标"区域应该显示6个新的指标卡片
- 每个指标卡片显示正确的标题和数值
- 指标来源标记为LLM分析

### 场景2：指标格式识别测试
**步骤：**
1. 发送包含不同格式指标的分析请求
2. LLM回复包含多种格式：
   ```
   财务分析结果：
   
   收入：¥2,500,000
   利润率：12.8%
   成本: €45,678.90
   ROI: +25%
   用户增长: 2,345人
   市场份额：8.5%
   ```

**预期结果：**
- 正确识别中文冒号（：）和英文冒号（:）
- 正确处理不同货币符号（¥、€、$）
- 正确识别百分比和数量格式
- 显示格式化后的数值

### 场景3：指标切换功能测试
**步骤：**
1. 发送第一个分析请求："分析销售趋势"，等待回复和指标显示
2. 发送第二个分析请求："分析用户行为"，等待回复和指标显示
3. 点击第一个用户请求（销售趋势）
4. 点击第二个用户请求（用户行为）

**预期结果：**
- 点击第一个用户请求时，Dashboard显示销售相关的指标
- 点击第二个用户请求时，Dashboard显示用户行为相关的指标
- 指标能够正确切换，不会混淆

### 场景4：无指标的分析请求
**步骤：**
1. 发送一个不包含数字指标的请求："解释数据分析的重要性"
2. 点击这个用户请求

**预期结果：**
- Dashboard应该恢复显示系统默认的指标
- 不会显示空的或错误的指标卡片

### 场景5：指标数量限制测试
**步骤：**
1. 发送请求，LLM回复包含超过6个指标：
   ```
   详细分析结果：
   
   销售额: $100,000
   利润: $25,000
   成本: $75,000
   订单数: 500
   客户数: 300
   转化率: 5%
   增长率: 10%
   满意度: 85%
   退货率: 2%
   复购率: 40%
   ```

**预期结果：**
- Dashboard只显示前6个指标
- 不会因为指标过多而影响界面布局
- 性能保持良好

### 场景6：指标格式过滤测试
**步骤：**
1. 发送请求，LLM回复包含混合内容：
   ```
   分析结果如下：
   
   销售额: $50,000  (这是一个有效指标)
   网址: https://example.com  (这不应该被提取)
   代码: ```SELECT * FROM sales```  (这不应该被提取)
   很长的描述文本，超过50个字符的标题不应该被提取: 123
   有效指标: 456
   ```

**预期结果：**
- 只提取有效的指标（销售额: $50,000 和 有效指标: 456）
- 过滤掉URL、代码块和过长的标题
- 显示的指标质量高，相关性强

## 调试信息

### 控制台日志
测试时注意观察浏览器控制台的以下日志：

```
[DEBUG] Dashboard metrics update received: {userMessageId: "...", metrics: [...]}
[DEBUG] Loading insights and metrics for message: messageId
[DEBUG] Found metrics for message: [...]
[DEBUG] No metrics found for message: messageId
```

### 状态检查
在浏览器开发者工具中检查以下状态：
- `sessionMetrics` 对象应该包含每个用户消息的指标
- `dashboardData.metrics` 应该包含当前显示的所有指标
- LLM指标应该有 `source: 'llm_analysis'` 标记

## 常见问题排查

### 问题1：指标没有显示在Dashboard
**可能原因：**
- LLM回复格式不符合提取规则
- MessageBubble没有正确识别指标模式
- 事件发送失败

**排查步骤：**
1. 检查LLM回复是否包含符合格式的指标
2. 检查控制台是否有相关错误
3. 确认MessageBubble的userMessageId是否正确

### 问题2：指标切换不正确
**可能原因：**
- 消息ID关联错误
- 状态更新时机问题
- 事件监听器问题

**排查步骤：**
1. 检查用户消息点击事件是否正确发送messageId
2. 确认sessionMetrics状态是否正确存储
3. 检查Dashboard更新逻辑

### 问题3：指标格式错误或重复
**可能原因：**
- 正则表达式匹配问题
- 指标过滤逻辑问题
- 状态清理不完整

**排查步骤：**
1. 检查正则表达式是否正确匹配
2. 确认指标过滤逻辑正确
3. 检查状态更新的原子性

### 问题4：性能问题
**可能原因：**
- 大量指标处理
- 正则表达式性能问题
- 频繁的状态更新

**排查步骤：**
1. 检查指标数量限制是否生效
2. 优化正则表达式性能
3. 检查是否有不必要的重复处理

## 性能测试

### 大量指标测试
1. 发送包含20+个指标的分析请求
2. 观察提取和显示性能
3. 检查内存使用情况

### 频繁切换测试
1. 快速点击不同的用户请求
2. 观察指标切换的响应速度
3. 检查是否有内存泄漏

### 复杂格式测试
1. 测试包含复杂数字格式的指标
2. 测试特殊字符和Unicode字符
3. 观察处理性能和准确性

## 验收标准

✅ **基本功能**
- [ ] LLM指标能够正确提取并显示在Dashboard
- [ ] 指标格式识别准确（货币、百分比、数量）
- [ ] 指标与用户请求正确关联

✅ **切换功能**
- [ ] 点击不同用户请求时指标能够正确切换
- [ ] 指标显示有适当的视觉区分
- [ ] 无指标的请求能够恢复系统默认指标

✅ **质量保证**
- [ ] 指标过滤规则有效，质量高
- [ ] 指标数量限制生效，不会过多
- [ ] 不会出现重复或错误的指标

✅ **性能稳定**
- [ ] 大量指标处理不会影响性能
- [ ] 频繁切换响应迅速
- [ ] 长时间使用不会出现性能问题

✅ **用户体验**
- [ ] 指标显示清晰，易于理解
- [ ] 切换操作直观，响应及时
- [ ] 与洞察功能协调一致

## 回归测试

### 现有功能验证
1. **洞察功能**：确保指标功能不影响洞察的正常工作
2. **图表显示**：确保指标功能不影响图表的显示
3. **系统指标**：确保系统默认指标能够正常显示和恢复

### 兼容性测试
1. **不同LLM回复格式**：测试各种LLM回复格式的兼容性
2. **多语言支持**：测试中英文混合内容的处理
3. **浏览器兼容性**：测试不同浏览器的兼容性

### 边界条件测试
1. **空内容处理**：测试空的或无效的LLM回复
2. **异常格式处理**：测试包含异常格式的内容
3. **网络异常处理**：测试网络异常情况下的行为

## 总结

通过全面的测试，确保分析请求关键指标功能能够：
1. 准确提取和显示LLM分析结果中的关键指标
2. 根据用户选择智能切换指标内容
3. 提供高质量、相关性强的指标信息
4. 保持良好的性能和用户体验

这个功能将显著提升用户的数据分析体验，使用户能够快速获取和理解关键的数据指标。