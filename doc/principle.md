# åˆ†æ Agent å·¥ä½œåŸç†ä¸æµç¨‹

æœ¬ç¨‹åºçš„åˆ†æ Agent æ˜¯ä¸€ä¸ªåŸºäº LLM çš„æ•°æ®åˆ†æå¼•æ“ï¼Œä½¿ç”¨ Go è¯­è¨€å®ç°ï¼Œæ ¸å¿ƒæ¡†æ¶ä¸º [Eino](https://github.com/cloudwego/eino)ï¼ˆå­—èŠ‚è·³åŠ¨å¼€æºçš„ AI ç¼–æ’æ¡†æ¶ï¼‰ã€‚æ•´ä½“æ¶æ„é‡‡ç”¨ **Tool-Use Agent æ¨¡å¼**ï¼šLLM ä½œä¸ºå†³ç­–ä¸­æ¢ï¼Œé€šè¿‡è°ƒç”¨å·¥å…·å®Œæˆæ•°æ®æŸ¥è¯¢ã€ä»£ç æ‰§è¡Œã€å›¾è¡¨ç”Ÿæˆç­‰ä»»åŠ¡ã€‚

---

## 1. å…¥å£ä¸è§¦å‘

ç”¨æˆ·åœ¨å‰ç«¯å‘é€æ¶ˆæ¯ â†’ `ChatService` æŒä¹…åŒ–æ¶ˆæ¯ â†’ è°ƒç”¨ `EinoService.RunAnalysisWithProgress()`ï¼Œè¿™æ˜¯æ•´ä¸ªåˆ†ææµç¨‹çš„ä¸»å…¥å£ã€‚å…¥å‚åŒ…æ‹¬ï¼šå¯¹è¯å†å²ã€æ•°æ®æº IDã€ä¼šè¯ç›®å½•ã€è¿›åº¦å›è°ƒç­‰ã€‚

---

## 2. æ¨¡æ¿å¿«é€ŸåŒ¹é…ï¼ˆFast Pathï¼‰

è¿›å…¥ä¸»æµç¨‹åï¼Œé¦–å…ˆå°è¯• **æ¨¡æ¿åŒ¹é…**ï¼ˆ`templates.DetectTemplate`ï¼‰ã€‚å¦‚æœç”¨æˆ·è¯·æ±‚åŒ¹é…åˆ°é¢„å®šä¹‰çš„åˆ†ææ¨¡æ¿ï¼ˆå¦‚ cohort åˆ†æã€é”€å”®æ¼æ–—ï¼‰ï¼Œç›´æ¥èµ°æ¨¡æ¿æ‰§è¡Œè·¯å¾„ï¼Œè·³è¿‡ LLM è°ƒç”¨ï¼Œé€Ÿåº¦æœ€å¿«ã€‚

---

## 3. åˆ†ç±» + è§„åˆ’ï¼ˆå•æ¬¡ LLM è°ƒç”¨ï¼‰

å¦‚æœæ¨¡æ¿æœªå‘½ä¸­ï¼Œè¿›å…¥ `CombinedClassifierPlanner.ClassifyAndPlan()`ã€‚è¿™æ˜¯ä¸€ä¸ªå…³é”®ä¼˜åŒ–â€”â€”å°†åŸæœ¬éœ€è¦ä¸¤æ¬¡ LLM è°ƒç”¨çš„"è¯·æ±‚åˆ†ç±»"å’Œ"æ‰§è¡Œè§„åˆ’"åˆå¹¶ä¸ºä¸€æ¬¡è°ƒç”¨ï¼Œè¿”å› `CombinedResult`ï¼š

**åˆ†ç±»ç»“æœï¼š**
- `RequestType`ï¼šconsultation / data_analysis / visualization / data_export / calculation / web_search
- `NeedsVisualization`ï¼šæ˜¯å¦éœ€è¦å›¾è¡¨
- `NeedsDataExport`ï¼šæ˜¯å¦éœ€è¦å¯¼å‡º
- `SuggestedChartType`ï¼šå»ºè®®çš„å›¾è¡¨ç±»å‹ï¼ˆline/bar/pie/scatter/heatmap ç­‰ï¼‰
- `Confidence`ï¼šç½®ä¿¡åº¦

**æ‰§è¡Œè®¡åˆ’ï¼š**
- `Complexity`ï¼štrivial / simple / moderate / complex
- `Steps`ï¼šå…·ä½“æ‰§è¡Œæ­¥éª¤ï¼ˆæ¯æ­¥åŒ…å« tool åç§°ã€ç›®çš„ã€ä¾èµ–å…³ç³»ï¼‰
- `IsQuickPath`ï¼šæ˜¯å¦å¯ä»¥ç›´æ¥æ‰§è¡Œï¼ˆå¦‚æ—¶é—´æŸ¥è¯¢ã€ç®€å•è®¡ç®—ï¼‰
- `EstimatedCalls`ï¼šé¢„ä¼°å·¥å…·è°ƒç”¨æ¬¡æ•°

ç»“æœå¸¦æœ‰ 5 åˆ†é’Ÿ TTL ç¼“å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚ã€‚

---

## 4. ä¸‰æ¡æ‰§è¡Œè·¯å¾„

æ ¹æ®åˆ†ç±»ç»“æœï¼Œè·¯ç”±åˆ°ä¸åŒçš„æ‰§è¡Œè·¯å¾„ï¼š

**è·¯å¾„ A â€” Quick Pathï¼ˆæ— éœ€ LLMï¼‰**
é€‚ç”¨äºæ—¶é—´/æ—¥æœŸæŸ¥è¯¢ã€ç®€å•æ•°å­¦è®¡ç®—ç­‰ã€‚ç›´æ¥ç”Ÿæˆ Python ä»£ç æ‰§è¡Œï¼Œä¸€æ­¥å®Œæˆã€‚

**è·¯å¾„ B â€” Unified Python Pathï¼ˆå•æ¬¡ä»£ç ç”Ÿæˆï¼‰**
é€‚ç”¨äºå¤§å¤šæ•°æ•°æ®åˆ†æè¯·æ±‚ã€‚æµç¨‹ï¼š
1. `UnifiedPythonGenerator` æ„å»º schema ä¸Šä¸‹æ–‡ï¼ˆè¡¨ç»“æ„ã€åˆ—åã€æ ·æœ¬æ•°æ®ï¼‰
2. `AnalysisPromptBuilder` æ„å»ºå®Œæ•´ promptï¼ˆå«åˆ†ç±» hintsã€ä»£ç æ¨¡æ¿ã€è¾“å‡ºè¦æ±‚ï¼‰
3. å•æ¬¡ LLM è°ƒç”¨ç”Ÿæˆå®Œæ•´ Python ä»£ç ï¼ˆåŒ…å« SQL æŸ¥è¯¢ + æ•°æ®å¤„ç† + å›¾è¡¨ç”Ÿæˆï¼‰
4. `CodeValidator` éªŒè¯ä»£ç å®‰å…¨æ€§
5. `ExecutionSafety` æ‰§è¡Œå®‰å…¨æ£€æŸ¥ï¼ˆç¦æ­¢å±é™©æ“ä½œï¼Œ120 ç§’è¶…æ—¶ï¼‰
6. `PythonPool`ï¼ˆ2 ä¸ª worker çš„è¿›ç¨‹æ± ï¼‰æ‰§è¡Œä»£ç 
7. `ResultParser` è§£æè¾“å‡ºï¼ˆå›¾è¡¨ã€è¡¨æ ¼ã€å¯¼å‡ºæ–‡ä»¶ï¼‰

**è·¯å¾„ C â€” Multi-Step Agent Loopï¼ˆå¤æ‚åˆ†æï¼‰**
å½“ Unified Path å¤±è´¥æˆ–è¯·æ±‚è¾ƒå¤æ‚æ—¶ï¼Œè¿›å…¥å®Œæ•´çš„ Agent å¾ªç¯ã€‚è¿™æ˜¯åŸºäº Eino çš„ Graph ç¼–æ’ï¼š

```
START â†’ [Model Node] â†â†’ [Tools Node] â†’ END
            â†‘                  |
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (å¾ªç¯ç›´åˆ° LLM ä¸å†è°ƒç”¨å·¥å…·)
```

- **Model Node**ï¼šè°ƒç”¨ LLMï¼Œç®¡ç†è®°å¿†ï¼ˆ`MemoryManager`ï¼‰ï¼Œæ³¨å…¥è¿­ä»£è­¦å‘Šï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
- **Tools Node**ï¼šæ‰§è¡Œ LLM è¯·æ±‚çš„å·¥å…·è°ƒç”¨ï¼Œè¿”å›ç»“æœ
- **åˆ†æ”¯é€»è¾‘**ï¼šå¦‚æœ LLM è¿”å› `ToolCalls`ï¼Œç»§ç»­å¾ªç¯ï¼›å¦åˆ™ç»“æŸ

ç¡¬é™åˆ¶ï¼šæœ€å¤š 12 æ¬¡è¿­ä»£ï¼Œè¶…è¿‡å¼ºåˆ¶ç»ˆæ­¢ã€‚åœ¨ 60%/70%/80% è¿›åº¦æ—¶æ³¨å…¥è­¦å‘Šæ¶ˆæ¯å‚¬ä¿ƒ LLM æ”¶æ•›ã€‚

---

## 5. å¯ç”¨å·¥å…·é›†

Agent å¯è°ƒç”¨çš„å·¥å…·ï¼ˆå¹¶è¡Œåˆå§‹åŒ–ï¼‰ï¼š

| å·¥å…· | åŠŸèƒ½ |
|------|------|
| `get_data_source_context` | è·å–æ•°æ®åº“ schemaï¼ˆè¡¨ã€åˆ—ã€ç±»å‹ã€æ ·æœ¬æ•°æ®ã€å…³ç³»ï¼‰ |
| `execute_sql` | æ‰§è¡Œ SQL æŸ¥è¯¢ï¼ˆæ”¯æŒ SQLite/MySQL/Dorisï¼‰ |
| `python_executor` | æ‰§è¡Œ Python ä»£ç ï¼ˆpandas/matplotlib/seabornï¼‰ |
| `query_and_chart` | **ç»„åˆå·¥å…·**ï¼šSQL æŸ¥è¯¢ + å›¾è¡¨ç”Ÿæˆä¸€æ­¥å®Œæˆ |
| `web_search` | ç½‘ç»œæœç´¢ï¼ˆç”¨äºéæ•°æ®åº“ç±»é—®é¢˜ï¼‰ |
| `web_fetch` | æŠ“å–ç½‘é¡µå†…å®¹ |
| `export_tool` | å¯¼å‡º Excel/CSV æ–‡ä»¶ |
| `mcp_service` | è°ƒç”¨å¤–éƒ¨ MCP æœåŠ¡ |
| `start_datasource_analysis` | åˆ—å‡ºæ•°æ®æº / å¯åŠ¨åˆ†æä¼šè¯ |

---

## 6. ä¸Šä¸‹æ–‡ç®¡ç†

- **MemoryManager**ï¼šåˆ†å±‚è®°å¿†ç®¡ç†ã€‚çŸ­æœŸä¿ç•™æœ€è¿‘ 5 æ¡å®Œæ•´æ¶ˆæ¯ï¼Œä¸­æœŸå‹ç¼©ä¸ºæ‘˜è¦ï¼Œé•¿æœŸæŒä¹…åŒ–å…³é”®å‘ç°
- **WorkingContextManager**ï¼šè·Ÿè¸ª UI çŠ¶æ€ï¼ˆå½“å‰å›¾è¡¨ã€ç­›é€‰æ¡ä»¶ï¼‰
- **ConversationContextManager**ï¼šè§£æå¯¹è¯ä¸­çš„æŒ‡ä»£å¼•ç”¨ï¼ˆå¦‚"ä¸Šé¢é‚£ä¸ª"â†’å…·ä½“å†…å®¹ï¼‰
- **SchemaContextBuilder**ï¼šæ„å»ºå¹¶ç¼“å­˜æ•°æ®åº“ schemaï¼Œè·¨è¯·æ±‚å¤ç”¨

---

## 7. è®°å½•ä¸å›æ”¾

- **AnalysisRecorder**ï¼šè®°å½•æ¯ä¸€æ­¥åˆ†ææ“ä½œï¼ˆå·¥å…·è°ƒç”¨ã€è¾“å…¥è¾“å‡ºã€LLM å¯¹è¯ï¼‰ï¼Œä¿å­˜ä¸º JSON
- **AnalysisReplayer**ï¼šåœ¨æ–°æ•°æ®æºä¸Šå›æ”¾å·²è®°å½•çš„åˆ†æã€‚é€šè¿‡ schema å…¼å®¹æ€§åˆ†æå’Œæ™ºèƒ½å­—æ®µæ˜ å°„ï¼ˆLLM è¾…åŠ©ï¼‰ï¼Œå°†åŸå§‹ SQL/Python ä»£ç é€‚é…åˆ°æ–°çš„è¡¨ç»“æ„
- **AgentTrajectory**ï¼šå®Œæ•´æ‰§è¡Œè½¨è¿¹è®°å½•ï¼Œç”¨äºæ¨¡å‹è®­ç»ƒå’Œæ€§èƒ½åˆ†æ
- **AnalysisPath**ï¼šæŒ‰"ç°è±¡â†’è¡ŒåŠ¨â†’ç»“è®º"æ¨¡å¼è®°å½•åˆ†ææ•…äº‹çº¿ï¼Œæ”¯æŒè‡ªåŠ¨æŠ¥å‘Šç”Ÿæˆ

---

## 8. è¿›åº¦ä¸å®¹é”™

- å‰ç«¯å®æ—¶è¿›åº¦æ›´æ–°ï¼ˆé€šè¿‡ `ProgressCallback`ï¼‰ï¼Œæ¯ 30 ç§’å¿ƒè·³ä¿æ´»
- å·¥å…·æ‰§è¡Œå¤±è´¥æ—¶ä¸ä¸­æ–­æµç¨‹ï¼Œè€Œæ˜¯å°†é”™è¯¯ä¿¡æ¯è¿”å›ç»™ LLM è®©å…¶è‡ªè¡Œä¿®æ­£ï¼ˆå¦‚ SQL è¯­æ³•é”™è¯¯ä¼šé™„å¸¦ä¿®å¤å»ºè®®ï¼‰
- å·¥å…·è¾“å‡ºè¶…è¿‡ 30000 å­—ç¬¦è‡ªåŠ¨æˆªæ–­ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡æº¢å‡º
- æ”¯æŒç”¨æˆ·éšæ—¶å–æ¶ˆåˆ†æ

---

## 9. Eino Graph ç¼–æ’è¯¦è§£

### æ ¸å¿ƒæ¦‚å¿µ

Eino æ˜¯å­—èŠ‚è·³åŠ¨å¼€æºçš„ AI åº”ç”¨ç¼–æ’æ¡†æ¶ï¼ˆç±»ä¼¼ LangChain çš„ Go ç‰ˆæœ¬ï¼‰ã€‚æœ¬ç¨‹åºä½¿ç”¨ Eino çš„ `compose` åŒ…æ„å»ºäº†ä¸€ä¸ªæœ‰çŠ¶æ€çš„å¾ªç¯å›¾ï¼ˆStateful Cyclic Graphï¼‰ï¼Œå®ç° ReActï¼ˆReasoning + Actingï¼‰æ¨¡å¼çš„ Agent å¾ªç¯ã€‚

Graph çš„æ³›å‹ç­¾åä¸ºï¼š

```go
g := compose.NewGraph[[]*schema.Message, []*schema.Message]()
```

è¾“å…¥å’Œè¾“å‡ºéƒ½æ˜¯ `[]*schema.Message`â€”â€”å³å®Œæ•´çš„å¯¹è¯å†å²ã€‚æ¯ä¸ªèŠ‚ç‚¹æ¥æ”¶å½“å‰çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œå¤„ç†åè¿”å›æ›´æ–°çš„æ¶ˆæ¯åˆ—è¡¨ã€‚è¿™æ„å‘³ç€**æ•´ä¸ªå¯¹è¯çŠ¶æ€é€šè¿‡æ¶ˆæ¯æ•°ç»„åœ¨èŠ‚ç‚¹é—´æµè½¬**ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½çœ‹åˆ°å®Œæ•´ä¸Šä¸‹æ–‡ã€‚

---

### å›¾çš„æ‹“æ‰‘ç»“æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                     â”‚
                    â–¼                                     â”‚
  START â”€â”€â†’ [ model èŠ‚ç‚¹ ] â”€â”€Branchâ”€â”€â†’ [ tools èŠ‚ç‚¹ ] â”€â”€â”€â”˜
                    â”‚
                    â””â”€â”€Branchâ”€â”€â†’ END
```

åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œä¸€æ¡åˆ†æ”¯é€»è¾‘ï¼š

```go
g.AddLambdaNode("model", modelLambda)   // LLM æ¨ç†èŠ‚ç‚¹
g.AddLambdaNode("tools", toolsLambda)   // å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹

g.AddEdge(compose.START, "model")       // å…¥å£ â†’ model
g.AddEdge("tools", "model")             // tools â†’ modelï¼ˆå›ºå®šå›è¾¹ï¼‰

g.AddBranch("model", compose.NewGraphBranch(
    func(ctx context.Context, history []*schema.Message) (string, error) {
        lastMsg := history[len(history)-1]
        if len(lastMsg.ToolCalls) > 0 {
            return "tools", nil    // LLM è¦è°ƒç”¨å·¥å…· â†’ å» tools èŠ‚ç‚¹
        }
        return compose.END, nil    // LLM ç›´æ¥è¾“å‡ºæ–‡æœ¬ â†’ ç»“æŸ
    },
    map[string]bool{"tools": true, compose.END: true},
))
```

åˆ†æ”¯åˆ¤æ–­é€»è¾‘æå…¶ç®€å•ï¼šçœ‹ LLM è¿”å›çš„æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦åŒ…å« `ToolCalls`ã€‚æœ‰å°±ç»§ç»­å¾ªç¯ï¼Œæ²¡æœ‰å°±ç»“æŸã€‚

---

### Model èŠ‚ç‚¹ï¼ˆmodelLambdaï¼‰è¯¦è§£

è¿™æ˜¯ Graph ä¸­æœ€å¤æ‚çš„èŠ‚ç‚¹ï¼Œæ¯æ¬¡è¢«è°ƒç”¨æ—¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

**â‘  è¿­ä»£è®¡æ•°ä¸å–æ¶ˆæ£€æŸ¥**
```go
iterationCount++
if cancelCheck != nil && cancelCheck() {
    return nil, fmt.Errorf("analysis cancelled by user")
}
```
æ¯æ¬¡è¿›å…¥éƒ½é€’å¢è®¡æ•°å™¨ï¼Œå¹¶æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹äº†å–æ¶ˆã€‚

**â‘¡ æ¶ˆæ¯å»é‡**
```go
input = deduplicateMessages(input)
```
ç§»é™¤é‡å¤çš„ user æ¶ˆæ¯ï¼Œé˜²æ­¢å› ä¸ºå¾ªç¯å¯¼è‡´çš„æ¶ˆæ¯å †ç§¯ã€‚

**â‘¢ æ¸è¿›å¼è­¦å‘Šæ³¨å…¥**

è¿™æ˜¯é˜²æ­¢ Agent æ— é™å¾ªç¯çš„æ ¸å¿ƒæœºåˆ¶ã€‚æ ¹æ® `maxSteps`ï¼ˆé»˜è®¤ 25ï¼Œå³çº¦ 12 æ¬¡è¿­ä»£ï¼‰åŠ¨æ€è®¡ç®—ä¸‰ä¸ªè­¦å‘Šé˜ˆå€¼ï¼š

```
~60% è¿­ä»£æ•° â†’ "âš¡ æ­¥éª¤å¤ªå¤šäº†ï¼Œå°½å¿«æ”¶å°¾ï¼Œæœ€å¤šå†è°ƒç”¨ 2 æ¬¡å·¥å…·"
~70% è¿­ä»£æ•° â†’ "âš ï¸ æ­¥éª¤å¤ªå¤šäº†ï¼Œç«‹å³å±•ç¤ºç»“æœï¼Œä¸è¦å†è°ƒç”¨å·¥å…·"
~80% è¿­ä»£æ•° â†’ "ğŸ›‘ åœï¼ç«‹å³è¾“å‡ºå½“å‰ç»“æœ"
```

å¯¹äºå¤æ‚åˆ†æï¼ˆ`EstimatedCalls >= 5`ï¼‰ï¼Œé˜ˆå€¼ä¼šåç§»ï¼Œç»™ LLM æ›´å¤šç©ºé—´ã€‚

å¦‚æœè¿­ä»£è¶…è¿‡ 12 æ¬¡ï¼Œç›´æ¥ç¡¬ç»ˆæ­¢ï¼š
```go
if iterationCount > 12 {
    forceStopMsg := &schema.Message{
        Role:    schema.Assistant,
        Content: "Analysis step limit reached. Outputting current results now.",
    }
    return append(input, forceStopMsg), nil
}
```
æ³¨æ„è¿™é‡Œè¿”å›çš„æ˜¯ Assistant æ¶ˆæ¯è€Œé ToolCallsï¼Œæ‰€ä»¥åˆ†æ”¯é€»è¾‘ä¼šå°†å…¶è·¯ç”±åˆ° ENDã€‚

**â‘£ è®°å¿†ç®¡ç†**

å¦‚æœå¯ç”¨äº†è®°å¿†åŠŸèƒ½ï¼Œåœ¨æ¯æ¬¡ LLM è°ƒç”¨å‰å‹ç¼©å¯¹è¯å†å²ï¼š

```go
managedInput, err = s.memoryManager.ManageMemory(ctx, input)
```

`ManageMemory` çš„ç­–ç•¥æ˜¯åˆ†å±‚é€’è¿›çš„ï¼š
1. å…ˆæˆªæ–­å·¥å…·è¾“å‡ºåˆ° 10000 å­—ç¬¦
2. è¿˜è¶…ï¼Ÿæˆªæ–­åˆ° 5000 å­—ç¬¦
3. è¿˜è¶…ï¼Ÿå‰¥ç¦»æ—§çš„å·¥å…·æ¶ˆæ¯
4. è¿˜è¶…ï¼Ÿåº”ç”¨åˆ†å±‚è®°å¿†ï¼ˆå‹ç¼©æ—§æ¶ˆæ¯ä¸ºæ‘˜è¦ï¼‰
5. æœ€åå…œåº•ï¼šåªä¿ç•™æœ€è¿‘ 4 æ¡æ¶ˆæ¯

ç›®æ ‡æ˜¯å°† token æ•°æ§åˆ¶åœ¨ `ä¸Šä¸‹æ–‡çª—å£ - è¾“å‡ºé¢„ç•™ - 20% å®‰å…¨ç¼“å†²` ä»¥å†…ã€‚

**â‘¤ LLM è°ƒç”¨**
```go
resp, err := s.ChatModel.Generate(ctx, managedInput)
```
è°ƒç”¨åº•å±‚ LLMï¼ˆOpenAI/Anthropic/Geminiï¼‰ï¼Œè¿”å›ä¸€æ¡ Assistant æ¶ˆæ¯ã€‚è¿™æ¡æ¶ˆæ¯å¯èƒ½åŒ…å«çº¯æ–‡æœ¬å›å¤ï¼Œä¹Ÿå¯èƒ½åŒ…å« `ToolCalls`ã€‚

**â‘¥ è½¨è¿¹è®°å½•**

æ¯æ¬¡ LLM è°ƒç”¨éƒ½è®°å½•åˆ° `AgentTrajectory`ï¼ŒåŒ…æ‹¬è¾“å…¥æ¶ˆæ¯ã€è¾“å‡ºæ¶ˆæ¯ã€è€—æ—¶ã€‚

**â‘¦ è¿”å›æ›´æ–°åçš„å†å²**
```go
return append(managedInput, resp), nil
```
å°† LLM çš„å›å¤è¿½åŠ åˆ°ï¼ˆå¯èƒ½å·²å‹ç¼©çš„ï¼‰æ¶ˆæ¯å†å²ä¸­ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

---

### Tools èŠ‚ç‚¹ï¼ˆtoolsLambdaï¼‰è¯¦è§£

**â‘  å–æ¶ˆæ£€æŸ¥ + è¿›åº¦æ¨é€**

æ ¹æ®å·¥å…·åç§°æŸ¥æ‰¾ `ToolProgressMapping`ï¼Œå‘å‰ç«¯æ¨é€å¯¹åº”çš„è¿›åº¦é˜¶æ®µï¼š
```
get_data_source_context â†’ schema é˜¶æ®µ, 25%
execute_sql             â†’ query é˜¶æ®µ, 40%
python_executor         â†’ analysis é˜¶æ®µ, 60%
web_search              â†’ searching é˜¶æ®µ, 50%
export_data             â†’ exporting é˜¶æ®µ, 70%
```

**â‘¡ å·¥å…·æ‰§è¡Œ**
```go
toolResultMsg, err := toolsNode.Invoke(ctx, lastMsg)
```
Eino çš„ `ToolsNode` ä»æœ€åä¸€æ¡ Assistant æ¶ˆæ¯ä¸­æå–æ‰€æœ‰ `ToolCalls`ï¼Œæ ¹æ® `Function.Name` è·¯ç”±åˆ°å¯¹åº”çš„å·¥å…·å®ç°ï¼Œå¹¶è¡Œæ‰§è¡Œï¼ˆå¦‚æœæœ‰å¤šä¸ª tool callï¼‰ï¼Œè¿”å› `[]*schema.Message`ï¼ˆæ¯ä¸ª tool call å¯¹åº”ä¸€æ¡ Tool è§’è‰²çš„æ¶ˆæ¯ï¼Œé€šè¿‡ `ToolCallID` å…³è”ï¼‰ã€‚

**â‘¢ é”™è¯¯å¤„ç†â€”â€”ä¸ä¸­æ–­ï¼Œè€Œæ˜¯å¼•å¯¼ LLM è‡ªä¿®å¤**

è¿™æ˜¯ä¸€ä¸ªå…³é”®è®¾è®¡ï¼šå·¥å…·æ‰§è¡Œå¤±è´¥æ—¶ï¼Œä¸ä¼šè®©æ•´ä¸ª Graph æŠ¥é”™é€€å‡ºï¼Œè€Œæ˜¯å°†é”™è¯¯ä¿¡æ¯åŒ…è£…æˆ Tool æ¶ˆæ¯è¿”å›ç»™ LLMï¼Œè®©å®ƒè‡ªè¡Œä¿®æ­£ï¼š

```go
if err != nil {
    // ä¸ return errorï¼Œè€Œæ˜¯æ„é€ é”™è¯¯æ¶ˆæ¯
    for _, tc := range lastMsg.ToolCalls {
        if toolName == "execute_sql" {
            if strings.Contains(errStr, "no such column") {
                helpMsg = "âŒ SQL Column Error: ...\nğŸ”§ REQUIRED ACTION:\n1. Call get_data_source_context..."
            }
        }
        errorMsgs = append(errorMsgs, &schema.Message{
            Role: schema.Tool, Content: helpMsg, ToolCallID: tc.ID,
        })
    }
    return append(input, errorMsgs...), nil  // è¿”å›é”™è¯¯æ¶ˆæ¯ï¼Œä¸ä¸­æ–­å¾ªç¯
}
```

è¿™æ · LLM åœ¨ä¸‹ä¸€è½®è¿­ä»£ä¸­ä¼šçœ‹åˆ°é”™è¯¯ä¿¡æ¯ï¼Œå¹¶å°è¯•ä¿®æ­£ï¼ˆæ¯”å¦‚é‡å†™ SQLã€ä¿®å¤ Python ä»£ç ï¼‰ã€‚

**â‘£ è¾“å‡ºæˆªæ–­**

å·¥å…·è¾“å‡ºè¶…è¿‡ 30000 å­—ç¬¦æ—¶è‡ªåŠ¨æˆªæ–­ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡æº¢å‡ºï¼š
```go
if len(msg.Content) > maxToolOutputChars {
    msg.Content = msg.Content[:maxToolOutputChars] + "[... Output truncated]"
}
```

**â‘¤ æµå¼é¢„è§ˆ**

å·¥å…·æ‰§è¡Œç»“æœçš„å‰ 200 å­—ç¬¦ä¼šé€šè¿‡ `onProgress` å›è°ƒå®æ—¶æ¨é€åˆ°å‰ç«¯ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°ä¸­é—´è¿‡ç¨‹ã€‚

---

### ç¼–è¯‘ä¸æ‰§è¡Œ

```go
runnable, err := g.Compile(ctx, compose.WithMaxRunSteps(maxSteps))
```

`WithMaxRunSteps(25)` æ˜¯ Eino æ¡†æ¶çº§åˆ«çš„å®‰å…¨é˜€â€”â€”Graph æœ€å¤šæ‰§è¡Œ 25 æ­¥ï¼ˆæ¯æ¬¡ modelâ†’tools ç®— 2 æ­¥ï¼Œæ‰€ä»¥çº¦ 12 è½®è¿­ä»£ï¼‰ã€‚è¶…è¿‡åæ¡†æ¶è‡ªåŠ¨ç»ˆæ­¢ã€‚

æ‰§è¡Œæ—¶ï¼Œå°† System Prompt + å¯¹è¯å†å²ä½œä¸ºåˆå§‹è¾“å…¥ï¼š

```go
input := append([]*schema.Message{sysMsg}, managedHistory...)
finalHistory, err := runnable.Invoke(ctx, input)
```

System Prompt æ˜¯å¤šæ®µæ‹¼æ¥è€Œæˆçš„ï¼š
```
buildAnalysisSystemPrompt()     // åŸºç¡€åˆ†ææŒ‡ä»¤ï¼ˆi18nï¼‰
+ analysisPlanPrompt            // æ‰§è¡Œè®¡åˆ’ï¼ˆæ¥è‡ª CombinedClassifierPlannerï¼‰
+ contextPrompt                 // æ•°æ®æº schemaï¼ˆè¡¨åã€åˆ—åã€SQL æ–¹è¨€ï¼‰
+ workingContextPrompt          // UI å·¥ä½œä¸Šä¸‹æ–‡ï¼ˆå½“å‰å›¾è¡¨ã€ç­›é€‰æ¡ä»¶ï¼‰
+ conversationContextPrompt     // å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆæŒ‡ä»£è§£æï¼‰
+ mcpToolsPrompt                // MCP å¤–éƒ¨æœåŠ¡åˆ—è¡¨
+ languageDirective             // è¯­è¨€æŒ‡ä»¤ï¼ˆåŒ¹é…ç”¨æˆ·è¯­è¨€ï¼‰
```

---

### ä¸€æ¬¡å…¸å‹çš„æ‰§è¡Œè½¨è¿¹

å‡è®¾ç”¨æˆ·é—®"æŒ‰æœˆä»½ç»Ÿè®¡é”€å”®é¢å¹¶ç”»æŠ˜çº¿å›¾"ï¼š

```
Round 1:
  [model] æ”¶åˆ°: System + User("æŒ‰æœˆä»½ç»Ÿè®¡é”€å”®é¢å¹¶ç”»æŠ˜çº¿å›¾")
  [model] è¾“å‡º: ToolCall(get_data_source_context, {data_source_id: "abc"})
  [branch] â†’ tools
  [tools] æ‰§è¡Œ get_data_source_context â†’ è¿”å›è¡¨ç»“æ„
  [tools] â†’ model

Round 2:
  [model] æ”¶åˆ°: ...å†å² + Tool(schemaç»“æœ)
  [model] è¾“å‡º: ToolCall(query_and_chart, {query: "SELECT...", chart_code: "plt.plot..."})
  [branch] â†’ tools
  [tools] æ‰§è¡Œ query_and_chart â†’ SQLæŸ¥è¯¢ + ç”Ÿæˆå›¾è¡¨
  [tools] â†’ model

Round 3:
  [model] æ”¶åˆ°: ...å†å² + Tool(å›¾è¡¨ç»“æœ)
  [model] è¾“å‡º: "æ ¹æ®æ•°æ®åˆ†æï¼Œé”€å”®é¢åœ¨3æœˆè¾¾åˆ°å³°å€¼..."ï¼ˆçº¯æ–‡æœ¬ï¼Œæ—  ToolCallsï¼‰
  [branch] â†’ END
```

3 è½®è¿­ä»£ï¼Œ6 æ­¥ï¼Œå®Œæˆã€‚

---

### å¿ƒè·³æœºåˆ¶

Graph æ‰§è¡ŒæœŸé—´ï¼Œä¸€ä¸ªåå° goroutine æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³è¿›åº¦æ›´æ–°ï¼š

```go
go func() {
    ticker := time.NewTicker(30 * time.Second)
    for {
        select {
        case <-heartbeatCtx.Done(): return
        case <-ticker.C:
            onProgress(NewProgressUpdate(lastStage, lastProgress, lastMessage, 0, 0))
        }
    }
}()
```

è¿™é˜²æ­¢å‰ç«¯åœ¨ LLM é•¿æ—¶é—´æ€è€ƒæˆ– Python é•¿æ—¶é—´æ‰§è¡Œæ—¶è¯¯åˆ¤ä¸ºè¶…æ—¶è€Œæ¸…é™¤è¿›åº¦æ¡ã€‚å¿ƒè·³çŠ¶æ€é€šè¿‡ `heartbeatMu` äº’æ–¥é”ä¸ä¸»æµç¨‹åŒæ­¥ã€‚
