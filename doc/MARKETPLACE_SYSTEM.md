# VantageData 市场系统文档

## 概述

VantageData 分析技能包市场是一个独立的服务器端应用，允许用户分享、浏览和下载分析技能包（.qap 文件）。市场与 License 服务器集成，使用 SN + Email 认证方式，实现无缝的用户体验。

## 系统架构

```
┌─────────────────┐         ┌──────────────────┐         ┌─────────────────┐
│                 │         │                  │         │                 │
│  VantageData    │◄───────►│ License Server   │◄───────►│  Marketplace    │
│  Client         │         │ (认证)            │         │  Server         │
│                 │         │                  │         │                 │
└─────────────────┘         └──────────────────┘         └─────────────────┘
       │                                                          │
       │                                                          │
       └──────────────────────────────────────────────────────────┘
                    直接通信（下载/上传分析包）
```

## 认证流程

### 1. 用户激活

用户在 VantageData 客户端激活序列号时，需要提供邮箱地址。License 服务器会记录 SN 和 Email 的关联关系。

### 2. 市场登录

当用户访问市场功能时，客户端自动执行以下步骤：

1. **请求认证令牌**
   - 客户端向 License 服务器发送 SN + Email
   - License 服务器验证 SN 的有效性（未过期、未禁用）
   - License 服务器验证 Email 与 SN 的关联关系
   - 验证通过后，签发短期认证令牌（5 分钟有效）

2. **市场登录**
   - 客户端使用认证令牌向 Marketplace 服务器请求登录
   - Marketplace 服务器向 License 服务器验证令牌
   - 验证通过后，Marketplace 服务器签发市场 JWT（24 小时有效）
   - 首次登录自动创建市场用户账户

3. **后续请求**
   - 客户端使用市场 JWT 进行所有后续 API 调用
   - JWT 过期后自动重新执行登录流程

## 定价模式

市场支持四种定价模式：

### 1. 免费 (Free)

- 无需积分，直接下载使用
- 无使用限制
- 适合公开分享的通用分析包

### 2. 按次付费 (Per Use)

- 购买时扣除一次使用的 Credits
- 每次执行分析包消耗一次使用权
- 使用次数用完后可追加购买
- 适合高价值、低频使用的分析包

**示例**：
- 价格：10 Credits/次
- 购买后获得 1 次使用权
- 执行分析包后剩余 0 次
- 可再次购买追加使用次数

### 3. 限时 (Time Limited)

- 购买时扣除完整价格
- 在指定天数内无限次使用
- 到期后需重新购买
- 适合短期项目或试用场景

**示例**：
- 价格：50 Credits
- 有效期：30 天
- 购买后 30 天内无限次使用
- 30 天后需重新购买

### 4. 订阅 (Subscription)

- 按月或按年订阅
- 订阅期内无限次使用
- 到期前可续费
- 适合长期使用的核心分析包

**示例**：
- 月付：20 Credits/月
- 年付：200 Credits/年
- 订阅期内无限次使用
- 到期前可续费延长订阅

## 本地使用权限管理

客户端在本地维护使用权限信息，确保收费分析包按照购买的计费规则使用。

### 权限数据结构

```json
{
  "listing_id": "pack-uuid",
  "pack_name": "销售漏斗分析",
  "pricing_model": "per_use",
  "remaining_uses": 5,
  "expires_at": "2026-03-15T00:00:00Z",
  "billing_cycle": "monthly",
  "created_at": "2026-02-15T10:30:00Z"
}
```

### 权限检查逻辑

**按次付费**：
- 执行前检查 `remaining_uses > 0`
- 执行成功后 `remaining_uses -= 1`
- 用完后提示需要追加购买

**限时/订阅**：
- 执行前检查 `当前时间 < expires_at`
- 过期后提示需要续费或重新购买

**免费**：
- 无权限检查，直接执行

## Credits 系统

### Credits 获取

1. **新用户注册**：获得管理员配置的初始 Credits
2. **购买充值**：通过支付方式购买 Credits

### Credits 消费

- 下载收费分析包时自动扣除对应 Credits
- 追加购买使用次数时扣除 Credits
- 订阅续费时扣除一个周期的 Credits

### Credits 查询

- 用户可随时查询当前 Credits 余额
- 可查看 Credits 交易历史（充值、消费记录）

## 分析包分类

### 预设分类

市场预设以下电商平台分类：
- Shopify
- BigCommerce
- eBay
- Etsy

### 自定义分类

管理员可在管理面板中创建自定义分类：
- 输入分类名称和描述
- 分类可编辑和删除
- 删除前需确保无关联的分析包

## 分享流程

### 1. 选择分析包

在分析包管理界面，右键点击要分享的分析包，选择"分享到市场"。

### 2. 自动登录

系统自动使用本地 SN + Email 完成登录，无需用户手动操作。

### 3. 配置分享设置

- **选择分类**：从预设或自定义分类中选择
- **选择定价模式**：
  - 免费：无需设置价格
  - 按次付费：输入每次使用的 Credits 价格
  - 限时：输入 Credits 价格和有效天数
  - 订阅：输入 Credits 价格和计费周期（月付/年付）

### 4. 上传

确认后开始上传，显示上传进度。上传成功后分析包在市场中可见。

## 下载流程

### 1. 浏览市场

- 按分类筛选分析包
- 查看分析包详情（名称、描述、作者、定价信息）

### 2. 下载

- **免费包**：直接下载
- **收费包**：
  - 检查 Credits 余额是否充足
  - 余额充足则扣除 Credits 并下载
  - 余额不足则提示需要充值

### 3. 保存

- .qap 文件保存到本地
- 收费包的使用权限信息保存到本地

### 4. 导入

通过数据源右键菜单的"加载分析技能包"导入并执行。

## 管理面板

### 分类管理

- 创建新分类
- 编辑分类名称和描述
- 删除分类（需确保无关联分析包）
- 查看每个分类的分析包数量

### 用户管理

- 查看所有市场用户
- 查看用户的 Credits 余额
- 手动调整用户 Credits
- 查看用户的下载历史

### 分析包管理

- 查看所有已发布的分析包
- 编辑分析包信息
- 下架/恢复分析包
- 查看分析包的下载统计

### 系统配置

- 设置新用户初始 Credits
- 配置共享密钥（与 License 服务器保持一致）
- 查看系统统计信息

## API 接口

### 认证相关

- `POST /api/auth/sn-login` - SN + Email 登录
- `POST /api/auth/refresh` - 刷新 JWT

### 分析包相关

- `GET /api/packs` - 获取分析包列表
- `GET /api/packs/:id` - 获取分析包详情
- `POST /api/packs/upload` - 上传分析包
- `POST /api/packs/:id/download` - 下载分析包
- `POST /api/packs/:id/purchase` - 追加购买/续费

### 分类相关

- `GET /api/categories` - 获取所有分类
- `POST /api/categories` - 创建分类（管理员）
- `PUT /api/categories/:id` - 更新分类（管理员）
- `DELETE /api/categories/:id` - 删除分类（管理员）

### Credits 相关

- `GET /api/credits/balance` - 获取 Credits 余额
- `GET /api/credits/transactions` - 获取交易历史
- `POST /api/credits/purchase` - 购买 Credits

## 安全考虑

### 认证安全

- 使用 HMAC-SHA256 签名认证令牌
- 认证令牌有效期仅 5 分钟，防止重放攻击
- 市场 JWT 有效期 24 小时，定期刷新
- 共享密钥使用强随机字符串（至少 32 字符）

### 数据安全

- 所有 API 使用 HTTPS 加密传输
- 敏感数据（密钥、密码）通过环境变量配置
- 数据库使用 SQLite WAL 模式，确保数据一致性

### 权限控制

- 所有受保护 API 需要有效的 JWT
- 管理员操作需要额外的权限验证
- 用户只能访问自己的数据和公开数据

## 故障排查

### 登录失败

**问题**：自动登录失败，提示"认证失败"

**排查步骤**：
1. 检查客户端是否已激活序列号
2. 检查 SN 是否有效（未过期、未禁用）
3. 检查 Email 是否与 SN 关联
4. 检查 License 服务器是否正常运行
5. 检查共享密钥是否配置正确

### 下载失败

**问题**：下载分析包时提示"余额不足"

**解决方案**：
1. 查询当前 Credits 余额
2. 如余额不足，购买 Credits 充值
3. 重新尝试下载

### 执行失败

**问题**：执行收费分析包时提示"使用权限不足"

**排查步骤**：
1. 检查本地使用权限信息
2. 按次付费：检查 `remaining_uses` 是否大于 0
3. 限时/订阅：检查 `expires_at` 是否未过期
4. 如权限不足，追加购买或续费

## 最佳实践

### 分析包作者

1. **选择合适的定价模式**
   - 通用分析包：免费分享，扩大影响力
   - 专业分析包：按次付费或限时，适合特定场景
   - 核心分析包：订阅制，适合长期使用

2. **设置合理的价格**
   - 参考市场上类似分析包的价格
   - 考虑分析包的价值和复杂度
   - 提供试用版（免费或低价限时）

3. **完善分析包信息**
   - 清晰的名称和描述
   - 详细的使用说明
   - 准确的分类标签

### 分析包用户

1. **合理使用 Credits**
   - 优先下载免费分析包
   - 对比不同定价模式的性价比
   - 长期使用选择订阅制

2. **管理使用权限**
   - 定期检查使用权限状态
   - 及时续费或追加购买
   - 避免在权限不足时执行分析包

3. **反馈和评价**
   - 对使用过的分析包进行评价
   - 向作者反馈问题和建议
   - 帮助改进分析包质量

## 未来规划

### 短期（1-3 个月）

- 支持分析包评分和评论
- 添加分析包搜索功能
- 实现分析包版本管理

### 中期（3-6 个月）

- 支持分析包预览（无需下载即可查看）
- 添加分析包推荐系统
- 实现作者收益分成机制

### 长期（6-12 个月）

- 支持分析包协作编辑
- 添加分析包市场统计和分析
- 实现企业级市场（私有部署）

---

**文档版本**：1.0  
**最后更新**：2026-02-16
