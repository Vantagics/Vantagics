import { useState, useEffect } from 'react';
import { GetConfig } from '../wailsjs/go/main/App';
import { EventsOn } from '../wailsjs/runtime/runtime';

export type Language = 'English' | '简体中文';

export const translations: Record<Language, Record<string, string>> = {
    'English': {
        'data_sources': 'Data Sources',
        'chat_analysis': 'Chat Analysis',
        'add_source': '+ Add Source',
        'settings': 'Settings',
        'smart_dashboard': 'Smart Dashboard',
        'welcome_back': "Welcome back! Here's what's happening with your data.",
        'key_metrics': 'Key Metrics',
        'automated_insights': 'Automated Insights',
        'loading_insights': 'Loading your insights...',
        'ai_assistant': 'AI Assistant',
        'ready_to_help': 'Ready to help',
        'history': 'History',
        'new_chat': 'New Chat',
        'clear_history': 'CLEAR HISTORY',
        'what_to_analyze': 'What would you like to analyze?',
        'data_driven_reasoning': 'Data-driven reasoning',
        'visualized_summaries': 'Visualized summaries',
        'insights_at_fingertips': 'Insights at your fingertips',
        'ask_about_sales': 'Ask about sales trends, customer behavior, or request a complex data analysis.',
        'start_new_analysis': 'Start New Analysis',
        'ai_thinking': 'AI is thinking...',
        'clear_history_confirm_title': 'Clear All History?',
        'clear_history_confirm_desc': 'This action cannot be undone. All your chat threads will be permanently deleted.',
        'cancel': 'Cancel',
        'clear': 'Clear History',
        'preferences': 'Preferences',
        'llm_config': 'LLM Configuration',
        'system_params': 'System Parameters',
        'mcp_services': 'MCP Services',
        'drivers': 'Drivers',
        'run_env': 'Run Environment',
        'save_changes': 'Save Changes',
        'test_connection': 'Test Connection',
        'provider_type': 'Provider Type',
        'api_key': 'API Key',
        'base_url': 'Base URL (Optional)',
        'model_name': 'Model Name',
        'max_tokens': 'Max Tokens',
        'dark_mode': 'Dark Mode',
        'local_cache': 'Local Cache',
        'detailed_log': 'Detailed Log',
        'language': 'Language',
        'max_preview_rows': 'Max Preview Rows',
        'data_cache_dir': 'Data Cache Directory',
        'browse': 'Browse...',
        'add_data_source': 'Add Data Source',
        'source_name': 'Source Name',
        'driver_type': 'Driver Type',
        'file_path': 'File Path',
        'host': 'Host',
        'port': 'Port',
        'user': 'User',
        'password': 'Password',
        'database': 'Database',
        'store_locally': 'Store Locally',
        'import': 'Import',
        'importing': 'Importing',
        'properties': 'Properties',
        'created_at': 'Created At',
        'yes': 'Yes',
        'no': 'No',
        'close': 'Close',
        'db_path': 'DB Path',
        'err_same_source_target': 'Cannot export to the same database as the source.',
        'export_success': 'Data source "{0}" exported to "{1}" successfully.',
        'export_failed': 'Data source "{0}" export to "{1}" failed.\nError: {2}',
        'view_memory': 'View Memory',
        'view_results_directory': 'View Results Directory',
        'agent_memory': 'Agent Memory',
        'short_term_memory': 'Short Term',
        'medium_term_memory': 'Medium Term',
        'long_term_memory': 'Long Term',
        'test_connection_success': 'Connection successful!',
        'test_connection_failed': 'Connection failed',
        'confirm': 'Confirm',
        'start_analysis_confirm': 'Do you want to start analysis for "{0}"?',
        'start_analysis_title': 'Start Analysis',
        'analyze_suggestions_prompt': 'Give me some analysis suggestions for this data source.',
        'analysis_session_prefix': 'Analysis: ',
        'replay_analysis': 'Replay Analysis',
        'data_summary': 'Data Summary',
        'table_schema': 'Table Schema',
        'select_data_source': 'Select Data Source',
        'select_data_source_message': 'Please select a data source first, then start the analysis.',
        'delete_data_source_title': 'Delete Data Source',
        'delete_data_source_message': 'Are you sure you want to delete "{0}"? This action cannot be undone and will remove all associated data and configurations.',
        'delete_data_source_confirm': 'Delete',
        'delete_thread_title': 'Delete Chat Thread',
        'delete_thread_message': 'Are you sure you want to delete the chat thread "{0}"? This action cannot be undone and will remove all messages in this conversation.',
        'delete_thread_confirm': 'Delete',
        'deleting': 'Deleting...',
        'analysis_in_progress': 'Analysis in progress. Please wait for the current analysis to complete before starting a new one.',
        'previous': 'Previous',
        'next': 'Next',
        'previous_chart': 'Previous chart',
        'next_chart': 'Next chart',
        'no_data_sources_yet': 'No data sources added yet.',
        'skills': 'Skills',
        'delete_source': 'Delete source',
        'optimization_status': 'Optimization Status',
        'optimized': 'Optimized',
        'not_optimized': 'Not Optimized',
        'optimize_after_import': 'Optimize after import',
        'optimize_description': 'Automatically create indexes to improve query performance',
        'export_data': 'Export Data',
        'optimize_data_source': 'Optimize Data Source',
        'associated_chats': 'Associated Chats',
        'loading': 'Loading',
        'no_associated_chats': 'No associated chats found',
        // ContextPanel (Data Explorer)
        'data_explorer': 'Data Explorer',
        'select_data_source_to_explore': 'Select a data source from the sidebar to explore its contents.',
        'loading_data': 'Loading data...',
        'no_data_in_table': 'No data found in this table.',
        'tables': 'Tables',
        'back_to_tables': '← BACK TO TABLES',
        'showing_preview_rows': 'Showing up to {0} rows preview',
        'source': 'Source',
        'table': 'Table',
        'rows': 'Rows',
        // ChatSidebar
        'no_threads_yet': 'No threads yet',
        'cancel_analysis': 'Cancel',
        'cancel_analysis_title': 'Cancel Analysis',
        'cancel_analysis_message': 'Are you sure you want to cancel the current analysis? This action cannot be undone.',
        // Dashboard
        'double_click_to_zoom': 'Double click to zoom',
        'chart_data_format_error': 'Chart Data Format Error',
        'chart_contains_functions': 'This chart contains JavaScript functions and cannot be displayed. The data has been corrupted.',
        'export_dashboard': 'Export Dashboard',
        'export_as_html': 'Export as HTML',
        'export_as_pdf': 'Export as PDF',
        'no_exportable_content': 'No content available to export',
        'chart_type': 'Chart Type',
        'export_time': 'Export Time',
        'generated_by': 'Generated by RapidBI Smart Dashboard',
        'view_in_system': 'For interactive charts and real-time data, please visit the original system',
        'analysis_request': 'Analysis Request',
        'dashboard_report': 'Smart Dashboard Report',
        'generated_at': 'Generated at',
        'no_visualization_results': 'This analysis request has no visualization results yet.',
        'latest_analysis': 'Latest Analysis',
        // ExportDataSourceModal
        'select_tables': 'Select Tables',
        'select_all': 'Select All',
        'deselect_all': 'Deselect All',
        'no_tables_found': 'No tables found',
        'tables_selected': '{0} of {1} table(s) selected',
        'export_format': 'Export Format',
        'mysql_database': 'MySQL Database',
        'connect_to_server': 'Connect to Server',
        'connecting': 'Connecting...',
        'select_database': 'Select Database',
        'select_existing_database': '-- Select Existing Database --',
        'or_create_new': 'Or create new',
        'enter_new_database_name': 'Enter new database name',
        'connected_to': 'Connected to {0}:{1}',
        'back': 'Back',
        'connection': 'Connection',
        'please_connect_mysql': 'Please connect to MySQL server first.',
        'please_select_database': 'Please select a database.',
        'export': 'Export',
        'exporting': 'Exporting...',
        'please_select_table': 'Please select at least one table to export.',
        'username': 'Username',
        // NewChatModal
        'session_name': 'Session Name',
        'session_name_placeholder': 'e.g. Sales Analysis Q1',
        'validating': 'Validating...',
        'start_chat': 'Start Chat',
        'session_already_exists': 'A session named "{0}" already exists for this data source.',
        // Settings/Preferences
        'settings_saved_successfully': 'Settings saved successfully!',
        'settings_save_failed': 'Failed to save settings',
        // System Startup
        'system_startup': 'System Startup',
        'initializing': 'Initializing...',
        'checking_llm_config': 'Checking LLM Configuration...',
        'testing_llm_connection': 'Testing LLM Connection...',
        'api_key_missing': 'API Key is missing. Please configure LLM settings.',
        'connection_test_failed': 'Connection Test Failed',
        'open_settings': 'Open Settings',
        'retry_connection': 'Retry Connection',
        // Web Search MCP Service
        'web_search_mcp': 'Web Search MCP Service',
        'web_search_provider': 'Search Provider',
        'web_search_api_key': 'API Key',
        'web_search_mcp_url_preview': 'MCP URL Preview',
        'web_search_disabled': '-- Disabled (No Web Search) --',
        'web_search_description': 'Configure web search capabilities via MCP protocol',
        'apply_api_key': 'Apply for API Key',
        // AI Progress Messages
        'progress.initializing_tools': 'Initializing analysis tools...',
        'progress.tools_ready': 'Tools ready, building analysis graph...',
        'progress.loading_schema': 'Loading database structure...',
        'progress.executing_sql': 'Executing SQL query...',
        'progress.running_python': 'Running Python analysis...',
        'progress.ai_processing': 'AI processing (step {0})...',
        'progress.analysis_complete': 'Analysis complete',
        'progress.tool_completed': 'Tool {0} completed',
    },
    '简体中文': {
        'data_sources': '数据源',
        'chat_analysis': '对话分析',
        'add_source': '+ 添加数据源',
        'settings': '设置',
        'smart_dashboard': '智能仪表盘',
        'welcome_back': '欢迎回来！这是您的最新数据概览。',
        'key_metrics': '核心指标',
        'automated_insights': '自动化洞察',
        'loading_insights': '正在加载您的洞察数据...',
        'ai_assistant': 'AI 助手',
        'ready_to_help': '随时准备为您提供帮助',
        'history': '历史记录',
        'new_chat': '新建对话',
        'clear_history': '清空历史记录',
        'what_to_analyze': '您想分析什么？',
        'data_driven_reasoning': '数据驱动推理',
        'visualized_summaries': '可视化摘要',
        'insights_at_fingertips': '洞察近在咫尺',
        'ask_about_sales': '您可以询问销售趋势、用户行为，或请求复杂的数据分析。',
        'start_new_analysis': '开始新分析',
        'ai_thinking': 'AI 正在思考...',
        'clear_history_confirm_title': '清空所有历史记录？',
        'clear_history_confirm_desc': '此操作无法撤销。您的所有聊天记录都将被永久删除。',
        'cancel': '取消',
        'clear': '清空历史',
        'preferences': '系统偏好设置',
        'llm_config': 'LLM 配置',
        'system_params': '系统参数',
        'mcp_services': 'MCP 服务',
        'drivers': '驱动程序',
        'run_env': '运行环境',
        'save_changes': '保存更改',
        'test_connection': '测试连接',
        'provider_type': '供应商类型',
        'api_key': 'API 密钥',
        'base_url': '基础 URL (可选)',
        'model_name': '模型名称',
        'max_tokens': '最大 Token 数',
        'dark_mode': '深色模式',
        'local_cache': '本地缓存',
        'detailed_log': '详细日志',
        'language': '语言',
        'max_preview_rows': '数据预览行数',
        'data_cache_dir': '数据缓存目录',
        'browse': '浏览...',
        'add_data_source': '添加数据源',
        'source_name': '数据源名称',
        'driver_type': '驱动类型',
        'file_path': '文件路径',
        'host': '主机',
        'port': '端口',
        'user': '用户名',
        'password': '密码',
        'database': '数据库',
        'store_locally': '存储至本地',
        'import': '导入',
        'importing': '正在导入',
        'properties': '属性',
        'created_at': '创建时间',
        'yes': '是',
        'no': '否',
        'close': '关闭',
        'db_path': '数据库路径',
        'err_same_source_target': '源数据库与目标数据库不能相同。',
        'export_success': '数据源 "{0}" 导出到 "{1}" 成功。',
        'export_failed': '数据源 "{0}" 导出到 "{1}" 失败。\n错误：{2}',
        'view_memory': '查看记忆',
        'view_results_directory': '查看结果目录',
        'agent_memory': 'Agent 记忆',
        'short_term_memory': '短期记忆',
        'medium_term_memory': '中期记忆',
        'long_term_memory': '长期记忆',
        'test_connection_success': '连接成功！',
        'test_connection_failed': '连接失败',
        'confirm': '确定',
        'start_analysis_confirm': '您确定要对 "{0}" 启动分析吗？',
        'start_analysis_title': '启动分析',
        'analyze_suggestions_prompt': '请给出一些本数据源的分析建议。',
        'analysis_session_prefix': '分析：',
        'replay_analysis': '分析重放',
        'data_summary': '数据摘要',
        'table_schema': '表结构',
        'select_data_source': '选择数据源',
        'select_data_source_message': '请先选择一个数据源，然后再开始分析。',
        'delete_data_source_title': '删除数据源',
        'delete_data_source_message': '您确定要删除 "{0}" 吗？此操作无法撤销，将删除所有相关数据和配置。',
        'delete_data_source_confirm': '删除',
        'delete_thread_title': '删除聊天会话',
        'delete_thread_message': '您确定要删除聊天会话 "{0}" 吗？此操作无法撤销，将删除此对话中的所有消息。',
        'delete_thread_confirm': '删除',
        'deleting': '删除中...',
        'analysis_in_progress': '分析进行中，请等待当前分析完成后再发起新的分析',
        'previous': '上一个',
        'next': '下一个',
        'previous_chart': '上一张图',
        'next_chart': '下一张图',
        'no_data_sources_yet': '还没有添加数据源。',
        'skills': '技能',
        'delete_source': '删除数据源',
        'optimization_status': '优化状态',
        'optimized': '已优化',
        'not_optimized': '未优化',
        'optimize_after_import': '导入后优化数据',
        'optimize_description': '自动创建索引以提升查询性能',
        'export_data': '导出数据',
        'optimize_data_source': '数据源优化',
        'associated_chats': '关联的对话',
        'loading': '加载中',
        'no_associated_chats': '未找到关联的对话',
        // ContextPanel (Data Explorer)
        'data_explorer': '数据浏览器',
        'select_data_source_to_explore': '从侧边栏选择一个数据源以浏览其内容。',
        'loading_data': '加载数据中...',
        'no_data_in_table': '此表中未找到数据。',
        'tables': '表',
        'back_to_tables': '← 返回表列表',
        'showing_preview_rows': '显示最多 {0} 行预览',
        'source': '数据源',
        'table': '表',
        'rows': '行',
        // ChatSidebar
        'no_threads_yet': '还没有会话',
        'cancel_analysis': '取消',
        'cancel_analysis_title': '取消分析',
        'cancel_analysis_message': '您确定要取消当前分析吗？此操作无法撤销。',
        // Dashboard
        'double_click_to_zoom': '双击放大',
        'chart_data_format_error': '图表数据格式错误',
        'chart_contains_functions': '此图表包含 JavaScript 函数，无法显示。数据已损坏。',
        'export_dashboard': '导出仪表盘',
        'export_as_html': '导出为 HTML',
        'export_as_pdf': '导出为 PDF',
        'no_exportable_content': '没有可导出的内容',
        'chart_type': '图表类型',
        'export_time': '导出时间',
        'generated_by': '由 RapidBI 智能仪表盘生成',
        'view_in_system': '如需查看交互式图表和实时数据，请访问原系统',
        'analysis_request': '分析请求',
        'dashboard_report': '智能仪表盘报告',
        'generated_at': '生成时间',
        'no_visualization_results': '此分析请求尚无可视化结果。',
        'latest_analysis': '最新分析',
        // ExportDataSourceModal
        'select_tables': '选择表',
        'select_all': '全选',
        'deselect_all': '取消全选',
        'no_tables_found': '未找到表',
        'tables_selected': '已选择 {0} / {1} 个表',
        'export_format': '导出格式',
        'mysql_database': 'MySQL 数据库',
        'connect_to_server': '连接到服务器',
        'connecting': '连接中...',
        'select_database': '选择数据库',
        'select_existing_database': '-- 选择现有数据库 --',
        'or_create_new': '或创建新数据库',
        'enter_new_database_name': '输入新数据库名称',
        'connected_to': '已连接到 {0}:{1}',
        'back': '返回',
        'connection': '连接',
        'please_connect_mysql': '请先连接到 MySQL 服务器。',
        'please_select_database': '请选择一个数据库。',
        'export': '导出',
        'exporting': '导出中...',
        'please_select_table': '请至少选择一个表进行导出。',
        'username': '用户名',
        // NewChatModal
        'session_name': '会话名称',
        'session_name_placeholder': '例如：第一季度销售分析',
        'validating': '验证中...',
        'start_chat': '开始对话',
        'session_already_exists': '此数据源已存在名为"{0}"的会话。',
        // Settings/Preferences
        'settings_saved_successfully': '设置保存成功！',
        'settings_save_failed': '设置保存失败',
        // System Startup
        'system_startup': '系统启动',
        'initializing': '初始化中...',
        'checking_llm_config': '检查LLM配置...',
        'testing_llm_connection': '测试LLM连接...',
        'api_key_missing': 'API密钥缺失。请配置LLM设置。',
        'connection_test_failed': '连接测试失败',
        'open_settings': '打开设置',
        'retry_connection': '重试连接',
        // Web Search MCP Service
        'web_search_mcp': 'Web 搜索 MCP 服务',
        'web_search_provider': '搜索服务商',
        'web_search_api_key': 'API 密钥',
        'web_search_mcp_url_preview': 'MCP URL 预览',
        'web_search_disabled': '-- 禁用（不启用网络搜索） --',
        'web_search_description': '通过 MCP 协议配置网络搜索功能',
        'apply_api_key': '申请 API Key',
        // AI进度消息
        'progress.initializing_tools': '正在初始化分析工具...',
        'progress.tools_ready': '工具就绪，正在构建分析图谱...',
        'progress.loading_schema': '正在加载数据库结构...',
        'progress.executing_sql': '正在执行SQL查询...',
        'progress.running_python': '正在运行Python分析...',
        'progress.ai_processing': 'AI处理中 (步骤 {0})...',
        'progress.analysis_complete': '分析完成',
        'progress.tool_completed': '工具 {0} 已完成',
    }
};

export function useLanguage() {
    const [language, setLanguage] = useState<Language>('English');

    const updateLanguage = () => {
        GetConfig().then(config => {
            if (config.language === '简体中文' || config.language === 'English') {
                setLanguage(config.language as Language);
            }
        }).catch(console.error);
    };

    useEffect(() => {
        updateLanguage();
        // Listen for config changes
        const unsubscribe = EventsOn('config-updated', () => {
            updateLanguage();
        });
        return () => {
            if (unsubscribe) unsubscribe();
        };
    }, []);

    const t = (key: string, ...params: (string | number)[]) => {
        let text = translations[language][key] || key;
        // Replace {0}, {1}, etc. with provided parameters
        params.forEach((param, index) => {
            text = text.replace(`{${index}}`, String(param));
        });
        return text;
    };

    return { language, t };
}
