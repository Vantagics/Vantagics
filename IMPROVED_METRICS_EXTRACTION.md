# 改进的核心指标提取逻辑

## 功能描述
大幅改进关键指标提取逻辑，能够准确识别和提取结构化的核心数据，特别是类似以下格式的内容：

```
饮料类专项分析关键发现：
📊 核心指标
产品数量: 12个
饮料产品总收入: $197,769.74
总销售量: 3,467单位
平均周转率: 11.59次/年
平均库存天数: 105.3天
```

## 核心改进

### 1. 扩展的关键词库
不再局限于特定的业务关键词，而是涵盖更广泛的指标类型：

```typescript
const keyMetricKeywords = [
    // 基础指标
    '数量', '总数', '个数', '件数', 'count', 'number', 'quantity', 'total',
    // 金额相关
    '收入', '营收', '销售额', '利润', '成本', '费用', '金额', 'revenue', 'profit', 'sales', 'income', 'cost', 'amount',
    // 增长相关
    '增长率', '增长', '同比', '环比', 'growth', 'increase', 'rise', 'change',
    // 转化效率
    '转化率', '成功率', '效率', '周转率', 'conversion', 'rate', 'efficiency', 'turnover',
    // 时间相关
    '天数', '周期', '时间', '期间', 'days', 'period', 'time', 'duration',
    // 用户相关
    '用户', '客户', '访客', '活跃', 'users', 'customers', 'visitors', 'active',
    // 产品相关
    '产品', '商品', '库存', '销售量', 'products', 'items', 'inventory', 'volume',
    // 质量指标
    '满意度', '评分', '质量', '评价', 'satisfaction', 'rating', 'quality', 'score',
    // 市场指标
    '份额', '占比', '渗透', '覆盖', 'share', 'penetration', 'coverage',
    // 平均值
    '平均', '均值', '平均值', 'average', 'avg', 'mean'
];
```

### 2. 改进的模式匹配
支持更多样化的数据格式：

#### 模式1：标准格式
```regex
/([^:\n]{1,50})[：:]\s*([+\-]?[\d,]+\.?\d*)\s*([个件单位次年天月周%％$¥€£万千百万亿kmgtKMGT]*(?:\/[年月周天日]*)?)/gi
```
**匹配示例：**
- `产品数量: 12个`
- `总销售量: 3,467单位`
- `库存周转: 5次`

#### 模式2：货币格式
```regex
/([^:\n]{1,50})[：:]\s*([\$¥€£])\s*([+\-]?[\d,]+\.?\d*)/gi
```
**匹配示例：**
- `总收入: $197,769.74`
- `成本: ¥50,000`
- `利润: €25,500.50`

#### 模式3：百分比格式
```regex
/([^:\n]{1,50})[：:]\s*([+\-]?[\d,]+\.?\d*)\s*([%％])/gi
```
**匹配示例：**
- `增长率: 15.5%`
- `转化率: 3.2%`
- `满意度: 95%`

#### 模式4：比率格式
```regex
/([^:\n]{1,50})[：:]\s*([+\-]?[\d,]+\.?\d*)\s*(次\/[年月周天日]+)/gi
```
**匹配示例：**
- `平均周转率: 11.59次/年`
- `访问频率: 2.5次/月`
- `使用率: 8次/周`

#### 模式5：时间单位格式
```regex
/([^:\n]{1,50})[：:]\s*([+\-]?[\d,]+\.?\d*)\s*(天数?|小时|分钟|秒)/gi
```
**匹配示例：**
- `平均库存天数: 105.3天`
- `响应时间: 2.5秒`
- `处理时长: 45分钟`

### 3. 智能区域识别
优先识别明确标注的核心指标区域：

#### 中文模式
```regex
/(?:📊\s*)?(?:核心指标|关键指标|重要指标|关键发现|核心数据)[：:\s]*\n?([\s\S]*?)(?=\n\n|\n[^\s].*[：:]|$)/gi
```

#### 英文模式
```regex
/(?:📊\s*)?(?:core metrics?|key metrics?|important metrics?|key findings?|core data)[：:\s]*\n?([\s\S]*?)(?=\n\n|\n[^\s].*[：:]|$)/gi
```

#### 表情符号模式
```regex
/📊[^\n]*\n([\s\S]*?)(?=\n\n|\n[^\s].*[：:]|$)/gi
```

### 4. 双层提取策略

#### 第一层：区域优先提取
1. 首先搜索明确的核心指标区域
2. 在区域内提取所有符合格式的指标
3. 不需要关键词匹配，因为区域本身已经表明了重要性

#### 第二层：全文关键词提取
1. 如果没有找到明确的指标区域
2. 在整个内容中搜索包含关键词的指标
3. 确保提取的指标具有业务意义

### 5. 智能数据清理和验证

#### 标题清理
```typescript
const cleanTitle = title.replace(/^[^\w\u4e00-\u9fff]*/, '').trim();
```
- 移除标题开头的特殊字符
- 保留中文和英文字符
- 确保标题简洁明了

#### 数值验证
```typescript
const numericValue = parseFloat(value.replace(/,/g, ''));
if (!isNaN(numericValue) && numericValue >= 0) {
    // 有效数值
}
```
- 移除千分位分隔符
- 验证数值有效性
- 确保非负数

#### 趋势标识增强
```typescript
let change = '';
if (value.includes('+')) {
    change = '↗️ 上升';
} else if (value.includes('-')) {
    change = '↘️ 下降';
} else if (unit === '%' && numericValue > 10) {
    change = '📈 良好';
} else if (unit.includes('次/') || unit.includes('率')) {
    change = '🔄 周期';
}
```

### 6. 智能重要性排序
按业务重要性对指标进行排序：

```typescript
const getImportanceScore = (title: string) => {
    const titleLower = title.toLowerCase();
    if (titleLower.includes('收入') || titleLower.includes('revenue') || titleLower.includes('销售额')) return 5;
    if (titleLower.includes('增长') || titleLower.includes('growth')) return 4;
    if (titleLower.includes('数量') || titleLower.includes('总数') || titleLower.includes('count')) return 3;
    if (titleLower.includes('率') || titleLower.includes('rate') || titleLower.includes('效率')) return 2;
    return 1;
};
```

**优先级排序：**
1. **收入类指标**（最高优先级）：收入、销售额、revenue
2. **增长类指标**：增长率、growth、变化率
3. **数量类指标**：产品数量、用户数、总数
4. **效率类指标**：转化率、周转率、效率
5. **其他指标**：时间、质量等

## 提取示例

### 示例1：您提供的格式
**输入：**
```
饮料类专项分析关键发现：
📊 核心指标
产品数量: 12个
饮料产品总收入: $197,769.74
总销售量: 3,467单位
平均周转率: 11.59次/年
平均库存天数: 105.3天
```

**提取结果：**
1. **饮料产品总收入**: $197,769.74
2. **产品数量**: 12个
3. **平均周转率**: 11.59次/年 (🔄 周期)
4. **总销售量**: 3,467单位
5. **平均库存天数**: 105.3天

### 示例2：混合格式
**输入：**
```
业务分析报告

关键指标：
用户增长率: +25.5%
月活跃用户: 150,000人
平均订单金额: ¥89.50
客户满意度: 4.8分
转化率: 3.2%
```

**提取结果：**
1. **用户增长率**: +25.5% (↗️ 上升)
2. **月活跃用户**: 150,000人
3. **平均订单金额**: ¥89.50
4. **客户满意度**: 4.8分
5. **转化率**: 3.2%

### 示例3：英文格式
**输入：**
```
Q3 Performance Report

📊 Key Metrics
Total Revenue: $2,450,000
Growth Rate: +18.5%
Customer Count: 12,500 users
Average Order Value: $195.60
Conversion Rate: 4.2%
```

**提取结果：**
1. **Total Revenue**: $2,450,000
2. **Growth Rate**: +18.5% (↗️ 上升)
3. **Customer Count**: 12,500 users
4. **Average Order Value**: $195.60
5. **Conversion Rate**: 4.2%

## 技术特性

### 1. 多语言支持
- 支持中文和英文指标识别
- 支持混合语言内容
- 智能字符清理和验证

### 2. 多格式兼容
- 标准冒号分隔格式
- 货币符号前缀格式
- 百分比后缀格式
- 复合单位格式
- 比率表达格式

### 3. 智能容错
- 容忍格式变化
- 自动清理无效字符
- 数值验证和转换
- 长度限制保护

### 4. 性能优化
- 区域优先策略减少无效匹配
- 正则表达式优化
- 早期退出机制
- 调试日志支持

## 调试功能

### 调试日志
```typescript
console.log("[DEBUG] Found core metrics section:", sectionContent.substring(0, 100));
console.log("[DEBUG] Extracted metric:", { title: cleanTitle, value: formattedValue, change });
console.log("[DEBUG] Final extracted metrics count:", extractedMetrics.length);
```

### 提取过程跟踪
1. 区域识别阶段
2. 模式匹配阶段
3. 数据验证阶段
4. 排序和限制阶段

## 配置参数

### 可调整参数
- **最大指标数量**：6个（可调整）
- **标题长度限制**：1-50字符
- **数值验证**：非负数
- **重要性权重**：可自定义

### 扩展性
- 易于添加新的匹配模式
- 可扩展关键词库
- 可调整重要性评分算法
- 支持自定义趋势标识

## 总结

这个改进的指标提取逻辑具有以下优势：

1. **更强的识别能力**：能够准确识别各种格式的核心指标
2. **更智能的区域识别**：优先处理明确标注的指标区域
3. **更全面的格式支持**：支持货币、百分比、比率、时间等多种格式
4. **更准确的数据清理**：智能清理和验证提取的数据
5. **更合理的排序逻辑**：按业务重要性排序显示
6. **更好的用户体验**：提供更有意义的核心指标展示

这个改进确保了系统能够准确提取和显示真正有价值的核心业务指标，大大提升了数据分析的实用性。