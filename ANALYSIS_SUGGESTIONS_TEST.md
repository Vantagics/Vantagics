# 分析建议同步功能测试指南

## 测试场景

### 场景1：基本建议提取和显示
**步骤：**
1. 打开应用程序，确保有数据源连接
2. 在聊天区发送分析请求："请给出一些销售数据的分析建议"
3. 等待LLM回复包含编号列表的建议，例如：
   ```
   以下是一些销售数据分析建议：
   
   1. 销售趋势分析：查看月度销售变化
   2. 产品性能对比：比较不同产品的销售表现
   3. 客户细分分析：分析不同客户群体的购买行为
   4. 季节性分析：识别销售的季节性模式
   ```

**预期结果：**
- Dashboard的"自动洞察"区域应该显示4个新的洞察项
- 每个洞察项都有星形图标
- 洞察文本与LLM建议一致（去除编号和格式化）

### 场景2：建议点击执行
**步骤：**
1. 在场景1的基础上，点击Dashboard中的任一LLM建议
2. 观察是否创建新的分析会话

**预期结果：**
- 聊天侧边栏应该打开（如果之前关闭）
- 创建新的分析会话
- 发送对应的分析请求

### 场景3：多请求建议切换
**步骤：**
1. 发送第一个分析请求："分析销售趋势"，等待回复和建议显示
2. 发送第二个分析请求："分析客户行为"，等待回复和建议显示
3. 点击第一个用户请求（销售趋势）
4. 点击第二个用户请求（客户行为）

**预期结果：**
- 点击第一个用户请求时，Dashboard显示销售趋势相关的建议
- 点击第二个用户请求时，Dashboard显示客户行为相关的建议
- 建议能够正确切换，不会混淆

### 场景4：无建议的用户请求
**步骤：**
1. 发送一个不会产生建议列表的请求："你好"
2. 点击这个用户请求

**预期结果：**
- Dashboard应该清除之前的LLM建议
- 只显示系统默认的洞察项

### 场景5：建议格式过滤
**步骤：**
1. 发送请求，LLM回复包含混合格式：
   ```
   分析建议如下：
   
   1. 销售趋势分析：这是一个很好的分析方向
   2. 首先，我们需要了解数据结构
   3. 产品性能对比：比较不同产品表现
   4. 然后，我们可以进行深入分析
   ```

**预期结果：**
- 只有包含分析关键词的建议被提取（1和3）
- 解释性文本（2和4）被过滤掉
- Dashboard只显示有效的分析建议

## 调试信息

### 控制台日志
测试时注意观察浏览器控制台的以下日志：

```
[DEBUG] Dashboard insights update received: {userMessageId: "...", insights: [...]}
[DEBUG] Loading insights for message: messageId
[DEBUG] Found insights for message: [...]
[ChatSidebar] User message clicked: messageId
```

### 状态检查
在浏览器开发者工具中检查以下状态：
- `sessionInsights` 对象应该包含每个用户消息的建议
- `dashboardData.insights` 应该包含当前显示的所有洞察
- LLM建议应该有 `source: 'llm_suggestion'` 标记

## 常见问题排查

### 问题1：建议没有显示在Dashboard
**可能原因：**
- LLM回复格式不符合提取规则
- MessageBubble没有正确识别为建议上下文
- 事件发送失败

**排查步骤：**
1. 检查LLM回复是否包含编号列表
2. 检查控制台是否有相关错误
3. 确认MessageBubble的userMessageId是否正确

### 问题2：建议切换不正确
**可能原因：**
- 消息ID关联错误
- 状态更新时机问题
- 事件监听器问题

**排查步骤：**
1. 检查用户消息点击事件是否正确发送messageId
2. 确认sessionInsights状态是否正确存储
3. 检查Dashboard更新逻辑

### 问题3：建议重复或混乱
**可能原因：**
- 事件重复触发
- 状态清理不完整
- 建议过滤逻辑问题

**排查步骤：**
1. 检查useEffect依赖数组
2. 确认建议过滤逻辑正确
3. 检查状态更新的原子性

## 性能测试

### 大量建议测试
1. 发送请求获得10+个建议项
2. 观察Dashboard渲染性能
3. 检查内存使用情况

### 频繁切换测试
1. 快速点击不同的用户请求
2. 观察建议切换的响应速度
3. 检查是否有内存泄漏

### 长时间使用测试
1. 连续发送多个分析请求
2. 积累大量建议数据
3. 观察应用性能变化

## 验收标准

✅ **基本功能**
- [ ] LLM建议能够正确提取并显示在Dashboard
- [ ] 建议点击能够创建新的分析会话
- [ ] 建议与用户请求正确关联

✅ **交互体验**
- [ ] 点击不同用户请求时建议能够正确切换
- [ ] 建议显示有适当的视觉区分（星形图标）
- [ ] 无建议的请求能够清除之前的建议

✅ **稳定性**
- [ ] 不会出现重复或错误的建议
- [ ] 长时间使用不会出现性能问题
- [ ] 异常情况下不会崩溃

✅ **兼容性**
- [ ] 与现有智能洞察功能兼容
- [ ] 不影响其他Dashboard功能
- [ ] 支持多种LLM回复格式