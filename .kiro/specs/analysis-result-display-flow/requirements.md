# 分析结果显示流程优化

## 概述

整理并优化 Agent 分析结果（图片、ECharts、表格数据）在仪表盘区域的显示流程，确保分析完成后结果能正确完整地显示。

## 当前数据流程

### 1. 后端分析流程 (Go)

```
用户请求 → EinoService.RunAnalysisWithProgress()
    ↓
分类请求 (RequestTypeClassifier)
    ↓
生成 Python 代码 (UnifiedPythonGenerator)
    ↓
执行 Python 代码 (PythonPool/PythonService)
    ↓
解析执行结果 (ResultParser)
    ↓
检测生成的文件 (图片、Excel等)
    ↓
通过 EventAggregator 发送事件到前端
```

### 2. 事件发送 (Go → Frontend)

EventAggregator 支持的事件类型：
- `analysis-result-update`: 批量更新分析结果
- `analysis-result-clear`: 清除分析结果
- `analysis-result-loading`: 加载状态变更
- `analysis-result-error`: 错误通知
- `analysis-result-restore`: 恢复历史数据

支持的数据类型：
- `echarts`: ECharts 图表配置
- `image`: Base64 图片数据
- `table`: 表格数据
- `csv`: CSV 数据
- `metric`: 关键指标
- `insight`: 智能洞察
- `file`: 可下载文件

### 3. 前端数据接收 (TypeScript)

```
AnalysisResultBridge (事件监听)
    ↓
AnalysisResultManager (状态管理)
    ↓
useAnalysisResults Hook (数据订阅)
    ↓
useDashboardData Hook (数据转换)
    ↓
DraggableDashboard 组件 (渲染)
```

## 用户故事

### US-1: 图表结果显示
作为用户，当我请求数据分析时，我希望分析生成的图表（ECharts 或图片）能自动显示在仪表盘区域，这样我可以直观地理解分析结果。

验收标准：
- 1.1 ECharts 图表配置能正确解析并渲染
- 1.2 Python 生成的 PNG 图片能正确显示
- 1.3 多个图表时支持切换查看
- 1.4 图表支持双击放大查看

### US-2: 表格数据显示
作为用户，当分析结果包含表格数据时，我希望表格能清晰地显示在仪表盘区域，这样我可以查看详细数据。

验收标准：
- 2.1 表格数据能正确解析和显示
- 2.2 支持多种表格格式（JSON、CSV）
- 2.3 表格支持分页或滚动查看
- 2.4 列宽自适应内容

### US-3: 指标和洞察显示
作为用户，当分析结果包含关键指标和洞察时，我希望它们能醒目地显示，这样我可以快速了解分析要点。

验收标准：
- 3.1 指标卡片正确显示标题、数值、变化
- 3.2 洞察项可点击进行深入分析
- 3.3 数据源洞察支持启动智能分析

### US-4: 实时更新
作为用户，当分析正在进行时，我希望能看到实时的进度和部分结果，这样我知道系统正在工作。

验收标准：
- 4.1 分析开始时显示加载状态
- 4.2 部分结果能实时显示
- 4.3 分析完成时加载状态消失
- 4.4 错误时显示友好的错误信息

### US-5: 数据隔离
作为用户，当我切换会话或消息时，我希望仪表盘只显示当前选中消息的分析结果，不会与其他消息的结果混淆。

验收标准：
- 5.1 切换会话时清除旧数据
- 5.2 切换消息时只显示该消息的结果
- 5.3 历史消息的结果能正确恢复
- 5.4 无结果时显示空状态而非数据源统计

## 已识别的问题

### 问题 1: 图片检测不完整
当前 `detectAndEmitImages` 函数可能遗漏某些格式的图片引用。

### 问题 2: 图表保存路径不一致
LLM 生成的代码可能使用不同的路径格式保存图表，导致文件检测失败。

### 问题 3: 事件发送时机
分析完成后，可能存在事件发送顺序问题，导致前端接收数据不完整。

### 问题 4: 数据类型识别
某些数据类型（如 ECharts vs 普通 JSON）的识别可能不准确。

## 改进方向

1. 增强图片检测逻辑，支持更多格式
2. 统一图表保存路径处理
3. 确保事件发送的完整性和顺序
4. 改进数据类型识别算法
5. 添加调试日志便于问题排查
